# 24-12 Work Log - EOD Sales Summary Cross-Date Payments

# Card/Summary Cross-Date Payments (16–20 Sep)

## Issue Found

Card and summary_total mismatches remained for:

- `2025-09-16 / MB SHELL LEBUHRAYA UTARA / Take Away` (+51.55)
- `2025-09-17 / MB BYPASS KUANTAN / Take Away` (-8.50)
- `2025-09-18 / MB BYPASS KUANTAN / Take Away` (+8.50)

## Investigation

Direct queries in DW and Xilnex show payments where **payment_business_date is later than sales_date**:

- `MB SHELL LEBUHRAYA UTARA` has a card payment **51.55** with `sales_date=2025-09-12` but `payment_business_date=2025-09-16`.
- `MB BYPASS KUANTAN` has a card payment **8.50** with `sales_date=2025-09-17` but `payment_business_date=2025-09-18`.

Xilnex Excel buckets these payments into the **later payment business date**, which explains the card + summary_total differences.

## Fix Applied

Adjusted EOD Sales Summary payment aggregation to:

- keep filtering by `payment_business_date` in range
- set payment `business_date` to the **later of sales_date vs payment_business_date**
- remove the EOD business_date filter in `payment_agg` (to avoid dropping cross-date payments)

This targets the cross-date payment shift without pulling earlier payments into the range.

## Current Findings (After Fix)

Structure:

- API entries: 4091
- Xilnex entries: 4094
- Common: 4091
- Only in XN: 3
  - `2025-09-16 / MB NSK / Return / Delivery`
  - `2025-09-27`
  - `2025-09-29`

Metrics:

- Paths with all metrics matching: 4088
- Paths with any metric diff: 3
- `card_amount`: 4091/4091 (100%)
- `cash_amount`: 4089/4091
  - `2025-09-19 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away` api=992.7 vs xn=1021.0
  - `2025-09-20 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away` api=1449 vs xn=1420.7
- `other_amount`: 4090/4091
  - `2025-09-17 / MB NSK / Return / Delivery` api=-33.8 vs xn=0.0
- `summary_total`: 4088/4091
  - `2025-09-17 / MB NSK / Return / Delivery` api=-33.8 vs xn=0.0
  - `2025-09-19 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away` api=2192.64 vs xn=2220.94
  - `2025-09-20 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away` api=3001.59 vs xn=2973.29

---

# Cash Bucketing Exception for Cross-Date Payments

## Issue Found

After the cross-date payment fix, cash and summary_total mismatches appeared for:

- `2025-09-19 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away`
- `2025-09-20 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away`

## Investigation

Xilnex DB shows a cash payment **28.30** where:

- `sales_date = 2025-09-19`
- `payment_business_date = 2025-09-20`

Xilnex Excel keeps this cash on **sales_date** (19th), while card cross-date payments are shifted to the later payment date.

## Fix Applied

Payment bucketing updated:

- **cash** always uses `sales_date`
- non-cash still uses later of `sales_date` vs `payment_business_date`

## Result (16–20 Sep 2025)

Only NSK remains:

- Paths with any metric diff: **1**
- `other_amount`: 4090/4091 (diff only `2025-09-17 / MB NSK / Return / Delivery`)
- `summary_total`: 4090/4091 (diff only `2025-09-17 / MB NSK / Return / Delivery`)

---

# NSK Return Payment Shift

## Issue Found

Xilnex Excel showed a **payment-only** return row:

- `2025-09-16 / MB NSK / Return / Delivery` with `other_amount = -33.8` and `summary_total = -33.8`

API had the return on **2025-09-17** (sales and payment together), so the 09-16 payment-only row was missing.

## Investigation

Return sale:

- `90010247123` (Return, amount -33.8) on 2025-09-17
- Payment method = `other`, payment_business_date = 2025-09-17
- Original sale `90010247036` has `eod_business_date = 2025-09-16` (late-sync)

Xilnex Excel shifts the **return payment** to the **original sale's EOD business date**, while keeping the return sales metrics on the return date.

## Fix Applied

Targeted return payment shift:

- For Return payments only, if the **original sale** has `orig_sales_date != orig_eod_date` and `orig_eod_date` is in range, bucket the **return payment** to `orig_eod_date`.
- Emit a **payment-only row** when there is no matching sales row on that date.

## Result (16–20 Sep 2025)

All metrics match:

- API entries: 4092
- Xilnex entries: 4094
- Only in XN: 2 (2025-09-27, 2025-09-29)
- Metrics: **4092/4092 exact match**

---

# I-PARK KULAI Return Payment (15 May)

## Issue Found

`2025-05-14 / MB I-PARK KULAI / Return / Delivery` showed `other_amount` and `summary_total` as **0** in API but **-140.79** in Xilnex.

## Investigation

Return sale `9008201935` has:

- `sales_date = 2025-05-14`
- `eod_business_date = 2025-05-15`
- payment method = `other`, `payment_business_date = 2025-05-15`, amount **-140.79**

Xilnex keeps this **other** payment on the **return sales date**, not on the later payment business date.

## Fix Applied

Adjusted cross-date bucketing to shift **only card/debitcard/bank** payments to the later payment date.
`other` (and voucher) now remain on sales_date.

## Result (15 May 2025)

Exact match restored:

- Structure: API 820, XN 821 (only XN: `2025-05-20`)
- Metrics: **820/820 exact match**

---

# PD WATERFRONT ex-MGST + MB PETRON (Aug 31)

## Issues Found

- `MB PD WATERFRONT / Dine In` had `sales_net_amount_ex_mgst` mismatch (Xilnex used net when tax = 0 and net > total).
- `MB PETRON PASIR PANJANG SEKINCHAN` had card/summary gaps for 2025-08-30/31 due to cross-date payments.

## Investigation

PD WATERFRONT (2025-08-31):

- `total_sales = 6480.2`
- `sales_net_amount = 6501.1`
- `mgst_tax_amount = 0`
- Only 1 row in 2025-08-31 has `tax=0` and `net>total`.

MB PETRON PASIR PANJANG SEKINCHAN:

- Cross-date card payments exist on 2025-08-30 sales with `payment_business_date = 2025-08-31` (13.8, 41.95).
- These rows also have `eod_business_date = 2025-08-31`, while `sales_date = 2025-08-30`.

## Fix Applied

- `sales_net_amount_ex_mgst` uses `net_amount` only when `tax=0 AND net>total AND total>=0`.
- Card/debit/bank shift to payment date **only if** `eod_business_date == sales_date`; otherwise keep on sales_date.

## Result (31 Aug 2025)

Exact match restored:

- Structure: API 868, XN 868
- Metrics: **868/868 exact match**
