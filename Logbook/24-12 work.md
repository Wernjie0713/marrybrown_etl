# 24-12 Work Log - EOD Sales Summary Cross-Date Payments

# Card/Summary Cross-Date Payments (16–20 Sep)

## Issue Found

Card and summary_total mismatches remained for:

- `2025-09-16 / MB SHELL LEBUHRAYA UTARA / Take Away` (+51.55)
- `2025-09-17 / MB BYPASS KUANTAN / Take Away` (-8.50)
- `2025-09-18 / MB BYPASS KUANTAN / Take Away` (+8.50)

## Investigation

Direct queries in DW and Xilnex show payments where **payment_business_date is later than sales_date**:

- `MB SHELL LEBUHRAYA UTARA` has a card payment **51.55** with `sales_date=2025-09-12` but `payment_business_date=2025-09-16`.
- `MB BYPASS KUANTAN` has a card payment **8.50** with `sales_date=2025-09-17` but `payment_business_date=2025-09-18`.

Xilnex Excel buckets these payments into the **later payment business date**, which explains the card + summary_total differences.

## Fix Applied

Adjusted EOD Sales Summary payment aggregation to:

- keep filtering by `payment_business_date` in range
- set payment `business_date` to the **later of sales_date vs payment_business_date**
- remove the EOD business_date filter in `payment_agg` (to avoid dropping cross-date payments)

This targets the cross-date payment shift without pulling earlier payments into the range.

## Current Findings (After Fix)

Structure:

- API entries: 4091
- Xilnex entries: 4094
- Common: 4091
- Only in XN: 3
  - `2025-09-16 / MB NSK / Return / Delivery`
  - `2025-09-27`
  - `2025-09-29`

Metrics:

- Paths with all metrics matching: 4088
- Paths with any metric diff: 3
- `card_amount`: 4091/4091 (100%)
- `cash_amount`: 4089/4091
  - `2025-09-19 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away` api=992.7 vs xn=1021.0
  - `2025-09-20 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away` api=1449 vs xn=1420.7
- `other_amount`: 4090/4091
  - `2025-09-17 / MB NSK / Return / Delivery` api=-33.8 vs xn=0.0
- `summary_total`: 4088/4091
  - `2025-09-17 / MB NSK / Return / Delivery` api=-33.8 vs xn=0.0
  - `2025-09-19 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away` api=2192.64 vs xn=2220.94
  - `2025-09-20 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away` api=3001.59 vs xn=2973.29

---

# Cash Bucketing Exception for Cross-Date Payments

## Issue Found

After the cross-date payment fix, cash and summary_total mismatches appeared for:

- `2025-09-19 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away`
- `2025-09-20 / MB PETRON PASIR PANJANG SEKINCHAN / Take Away`

## Investigation

Xilnex DB shows a cash payment **28.30** where:

- `sales_date = 2025-09-19`
- `payment_business_date = 2025-09-20`

Xilnex Excel keeps this cash on **sales_date** (19th), while card cross-date payments are shifted to the later payment date.

## Fix Applied

Payment bucketing updated:

- **cash** always uses `sales_date`
- non-cash still uses later of `sales_date` vs `payment_business_date`

## Result (16–20 Sep 2025)

Only NSK remains:

- Paths with any metric diff: **1**
- `other_amount`: 4090/4091 (diff only `2025-09-17 / MB NSK / Return / Delivery`)
- `summary_total`: 4090/4091 (diff only `2025-09-17 / MB NSK / Return / Delivery`)

---

# NSK Return Payment Shift

## Issue Found

Xilnex Excel showed a **payment-only** return row:

- `2025-09-16 / MB NSK / Return / Delivery` with `other_amount = -33.8` and `summary_total = -33.8`

API had the return on **2025-09-17** (sales and payment together), so the 09-16 payment-only row was missing.

## Investigation

Return sale:

- `90010247123` (Return, amount -33.8) on 2025-09-17
- Payment method = `other`, payment_business_date = 2025-09-17
- Original sale `90010247036` has `eod_business_date = 2025-09-16` (late-sync)

Xilnex Excel shifts the **return payment** to the **original sale's EOD business date**, while keeping the return sales metrics on the return date.

## Fix Applied

Targeted return payment shift:

- For Return payments only, if the **original sale** has `orig_sales_date != orig_eod_date` and `orig_eod_date` is in range, bucket the **return payment** to `orig_eod_date`.
- Emit a **payment-only row** when there is no matching sales row on that date.

## Result (16–20 Sep 2025)

All metrics match:

- API entries: 4092
- Xilnex entries: 4094
- Only in XN: 2 (2025-09-27, 2025-09-29)
- Metrics: **4092/4092 exact match**

---

# I-PARK KULAI Return Payment (15 May)

## Issue Found

`2025-05-14 / MB I-PARK KULAI / Return / Delivery` showed `other_amount` and `summary_total` as **0** in API but **-140.79** in Xilnex.

## Investigation

Return sale `9008201935` has:

- `sales_date = 2025-05-14`
- `eod_business_date = 2025-05-15`
- payment method = `other`, `payment_business_date = 2025-05-15`, amount **-140.79**

Xilnex keeps this **other** payment on the **return sales date**, not on the later payment business date.

## Fix Applied

Adjusted cross-date bucketing to shift **only card/debitcard/bank** payments to the later payment date.
`other` (and voucher) now remain on sales_date.

## Result (15 May 2025)

Exact match restored:

- Structure: API 820, XN 821 (only XN: `2025-05-20`)
- Metrics: **820/820 exact match**

---

# PD WATERFRONT ex-MGST + MB PETRON (Aug 31)

## Issues Found

- `MB PD WATERFRONT / Dine In` had `sales_net_amount_ex_mgst` mismatch (Xilnex used net when tax = 0 and net > total).
- `MB PETRON PASIR PANJANG SEKINCHAN` had card/summary gaps for 2025-08-30/31 due to cross-date payments.

## Investigation

PD WATERFRONT (2025-08-31):

- `total_sales = 6480.2`
- `sales_net_amount = 6501.1`
- `mgst_tax_amount = 0`
- Only 1 row in 2025-08-31 has `tax=0` and `net>total`.

MB PETRON PASIR PANJANG SEKINCHAN:

- Cross-date card payments exist on 2025-08-30 sales with `payment_business_date = 2025-08-31` (13.8, 41.95).
- These rows also have `eod_business_date = 2025-08-31`, while `sales_date = 2025-08-30`.

## Fix Applied

- `sales_net_amount_ex_mgst` uses `net_amount` only when `tax=0 AND net>total AND total>=0`.
- Card/debit/bank shift to payment date **only if** `eod_business_date == sales_date`; otherwise keep on sales_date.

## Result (31 Aug 2025)

Exact match restored:

- Structure: API 868, XN 868
- Metrics: **868/868 exact match**

---

# New Report: Payment Type (All Payment) - Full Journey (24 Dec)

## Objective

Replicate the new report **"Payment type (All Payment)"** using the same parameters as EOD Sales Summary:

- `start_date`, `end_date`
- `outlet` (location keys)
- `sales_status`
- `payment_status`

Report structure (no date wrapper):

```
Store -> Order Source -> Payment Method -> Device Name -> Card Type -> Reference -> Metrics
```

Metrics:
`Total Collection`, `Cash Amount`, `Rounding Amount`, `Card Amount`, `Voucher Amount`, `E-Wallet Amount`, `Other Amount`

---

## Step 1: Excel Pattern Analysis

**Source Excel:**  
`C:\Users\yongw\Downloads\Payment type (All Payment)_24-12-2025 (Web) (1).xlsx`

**Key findings:**

- Header row is at row 0 (no offset).
- Grouping columns are fully populated (no forward-fill needed).
- "Total" rows appear at multiple levels and must be skipped:
  - `Store` (e.g., `MB A FAMOSA Total`, `Grand Total`)
  - `Order Source` (e.g., `LOCAL Total`)
  - `Payment Method` (e.g., `card Total`, `ewallet Total`)
  - `Device Name` (e.g., `RevenueMonster Total`)
  - `Card Type` (e.g., `TNGWALLET-RM Total`)
- No duplicate paths after removing Total rows.

---

## Step 2: Converter Script

**New script created:**  
`marrybrown_api/scripts/payment_type/convert_payment_type_excel.py`

**Behavior:**

- Reads the Excel with headers.
- Removes rows where any grouping column contains `Total`.
- Builds nested JSON:  
  `store -> order_source -> payment_method -> device_name -> card_type -> reference -> metrics`
- Outputs to:
  `c:\laragon\www\marrybrown_api\exports\Xilnex\Payment type (All Payment)_24-12-2025 (Web) (1).json`

**Run:**

```
python scripts\payment_type\convert_payment_type_excel.py "C:\Users\yongw\Downloads\Payment type (All Payment)_24-12-2025 (Web) (1).xlsx"
```

Result: **239 stores** exported.

---

## Step 3: Field Mapping Investigation

**Primary source tables:**

- `APP_4_PAYMENT` (amounts + payment attributes)
- `APP_4_SALES` (order source, sales status, joins)
- `LOCATION_DETAIL` (store name)

**Mappings:**

| Report Field     | Source Column                                            |
| ---------------- | -------------------------------------------------------- |
| Store            | `LOCATION_DETAIL.LOCATIONNAME`                           |
| Order Source     | `APP_4_SALES.ORDER_SOURCE`                               |
| Payment Method   | `APP_4_PAYMENT.METHOD`                                   |
| Device Name      | `APP_4_PAYMENT.DEVICE_NAME`                              |
| Card Type        | `APP_4_PAYMENT.STRING_EXTEND_2`                          |
| Reference        | `APP_4_PAYMENT.REFERENCE`                                |
| Total Collection | `SUM(DOUBLE_AMOUNT)`                                     |
| Cash Amount      | `METHOD='cash'`                                          |
| Card Amount      | `METHOD='card'`                                          |
| Voucher Amount   | `METHOD='voucher'`                                       |
| E-Wallet Amount  | `METHOD='ewallet'`                                       |
| Other Amount     | `METHOD='other'`                                         |
| Rounding Amount  | Not present in payment table (kept `0.0` to match Excel) |

**Payment filter:** `APP_4_PAYMENT.DATETIME__BUSINESS_DATE` with `STRING_EXTEND_3` status filter (Saved/Cancelled).

---

## Step 4: API Implementation

**Endpoint:**

```
GET /reports/payment-type-all-payment
```

**Parameters:** same as EOD Sales Summary (`start_date`, `end_date`, `location_keys`, `sales_statuses`, `payment_status`)

**Implementation:**  
`marrybrown_api/routers/reports.py`

**SQL design:**

- CTE `payment_base` joins `APP_4_PAYMENT` -> `APP_4_SALES` -> `LOCATION_DETAIL`
- Filters by:
  - `s.SALES_STATUS`
  - `p.DATETIME__BUSINESS_DATE`
  - `payment_status` (optional)
- Grouped by store/order_source/method/device/card_type/reference
- Computed metrics via conditional SUMs

---

## Step 5: API Run

**API call:**

```
GET http://127.0.0.1:8100/reports/payment-type-all-payment
?start_date=2025-08-31
&end_date=2025-08-31
&sales_statuses=COMPLETED
&payment_status=Saved
```

**Saved output:**

`c:\laragon\www\marrybrown_api\exports\Marrybrown\31-08-25_PaymentTypeAllPayment_API.json`

---

## Step 6: Comparison (Exact Match, No Tolerance)

**Results:**

| Metric              | Value  |
| ------------------- | ------ |
| API entries         | 13,094 |
| XN entries          | 13,094 |
| Common              | 13,094 |
| Only in API         | 0      |
| Only in XN          | 0      |
| Paths with any diff | 0      |

**Per-field accuracy (all 13,094 paths):**

- `total_collection` 100%
- `cash_amount` 100%
- `rounding_amount` 100%
- `card_amount` 100%
- `voucher_amount` 100%
- `ewallet_amount` 100%
- `other_amount` 100%

---

## Final Status

✅ **Payment Type (All Payment) report fully replicated**  
✅ **Converter + API + SQL match Xilnex Excel exactly**  
✅ **No discrepancies found**

---

# Payment Type (All Payment) - Multi-Date Verification (Before Fix)

## Test Files

1. `Payment type (All Payment)_24-12-2025 (Web) (2).xlsx` (2025-01-17, COMPLETED + Saved)
2. `Payment type (All Payment)_24-12-2025 (Web) (3).xlsx` (2025-05-15, COMPLETED + Saved)
3. `Payment type (All Payment)_24-12-2025 (Web) (4).xlsx` (2025-09-16 to 2025-09-20, COMPLETED + Saved)
4. `Payment type (All Payment)_24-12-2025 (Web) (6).xlsx` (2025-09-16 to 2025-09-20, CANCELLED + Cancelled)

## Current Findings (Before Fix)

### 1) 2025-01-17 (COMPLETED + Saved)

- API entries: 7,607
- XN entries: 7,607
- Structure: 100% (no missing paths)
- Discrepancies: 36 paths, all in `total_collection` only
- Pattern: `payment_method = bank` has XN values but API shows `0.0`
  - Example: `MB LARKIN SENTRAL / XILNEXKIOSK / bank / Tabsquare / (blank) / MaybankQR`

Root cause (suspected):
`total_collection` only sums methods in `('cash','card','voucher','ewallet','other')` and excludes `bank`.
XN appears to include `bank` in `total_collection`.

### 2) 2025-05-15 (COMPLETED + Saved)

- API entries: 7,677
- XN entries: 7,676
- Common: 7,676
- Only API: 1 path
- All metrics exact on common paths (100%)

### 3) 2025-09-16 to 2025-09-20 (COMPLETED + Saved)

- API entries: 42,043
- XN entries: 42,043
- 100% exact match across all fields

### 4) 2025-09-16 to 2025-09-20 (CANCELLED + Cancelled)

- API entries: 97
- XN entries: 97
- 100% exact match across all fields

---

## Planned Fix (Next Step)

Adjust `total_collection` calculation to include `bank` method.
Re-run API and comparisons to confirm 100% match for 2025-01-17.

---

# Payment Type (All Payment) - Fix Applied + Re-Comparison

## Fix Applied

Updated `/reports/payment-type-all-payment` in `routers/reports.py`:

- `total_collection` now includes `bank` in the SUM list:
  - Before: `cash, card, voucher, ewallet, other`
  - After: `cash, card, voucher, ewallet, other, bank`

## Re-Run: 2025-01-17 (COMPLETED + Saved)

- API entries: 7,607
- XN entries: 7,607
- Common: 7,606
- Only API: 1
- Only XN: 1
- Metrics: **100% exact on all common paths**

### Remaining mismatch (path only)

Reference casing difference:

- API only: `('MB GENTING PREMIUM OUTLET', 'LOCAL', 'voucher', '', '', 'gpo10')`
- XN only: `('MB GENTING PREMIUM OUTLET', 'LOCAL', 'voucher', '', '', 'GPO10')`

All metrics are identical; only Reference case differs.

## Summary (After Fix)

- Bank handling fixed; `total_collection` now matches XN for Jan 17.
- All other dates remain exact (no regression).
- Only outstanding difference is Reference casing for one voucher row.

---

# Payment Type (All Payment) - Re-Validation (After Fix)

## 2025-01-17 (COMPLETED + Saved)

- API entries: 7,607
- XN entries: 7,607
- Common: 7,606
- Only API: 1
- Only XN: 1
- Metrics: 100% exact on common paths

Remaining path-only mismatch:

- API only: `('MB GENTING PREMIUM OUTLET', 'LOCAL', 'voucher', '', '', 'gpo10')`
- XN only: `('MB GENTING PREMIUM OUTLET', 'LOCAL', 'voucher', '', '', 'GPO10')`

This is a **Reference casing** difference; values are identical.

## 2025-05-15 (COMPLETED + Saved)

- API entries: 7,677
- XN entries: 7,676
- Common: 7,676
- Only API: 1
- Only XN: 0
- Metrics: 100% exact on common paths

Only-API path:

- `('MB I-PARK KULAI', '', 'other', '', '', 'FOODPANDA')`

## 2025-09-16 to 2025-09-20 (COMPLETED + Saved)

- API entries: 42,043
- XN entries: 42,043
- Common: 42,043
- Only API: 0
- Only XN: 0
- Metrics: 100% exact on all paths

## 2025-09-16 to 2025-09-20 (CANCELLED + Cancelled)

- API entries: 97
- XN entries: 97
- Common: 97
- Only API: 0
- Only XN: 0
- Metrics: 100% exact on all paths

---

## Final Outcome

- Bank inclusion fixed Jan 17 totals.
- All metrics now match XN exactly on all common paths.
- Remaining differences are **path-only** (Reference casing and one missing Order Source path).

---
