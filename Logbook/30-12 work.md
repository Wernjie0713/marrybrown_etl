# 30-12 Work Log - Product Mix Investigation (Order Tables)

## Context

Continuing Product Mix discrepancy investigation. LocationPrice + RecipeSummary were added, but large mismatches remain. Next step is to pull Order-related tables to validate order-level pricing, packaging fee logic, and source/category mapping.

## Findings

Tables with data (likely relevant):

- `COM_5013.APP_4_ORDER`
- `COM_5013.APP_4_ORDERITEM`
  - Has `ORDER_SOURCE`, `DELIVERY_TYPE`, `ITEM_CATEGORY`, `BOOL_ISPACKAGE`, `DOUBLE_PRICE`, `DOUBLE_ENTER_PRICE`, etc.
  - Could explain packaging fee qty differences and which lines are considered reportable.

Menu/category mapping:

- `COM_5013.APP_4_MENUPROFILE`
- `COM_5013.APP_4_MENUPROFILEMAPPING`
- `COM_5013.APP_4_MENUMAINCATEGORY`
- `COM_5013.APP_4_MENUSUBCATEGORY`
- `COM_5013.APP_4_MENUITEMMODIFIER`
- `COM_5013.APP_4_MENUITEMOUTOFSTOCK`
  - Likely defines Category/Group Name seen in Excel and can be used to filter out component items.

Package + promo:

- `COM_5013.APP_4_PACKAGE`
- `COM_5013.APP_4_PROMOITEM`
- `COM_5013.APP_4_PROMORULE`
  - May explain bundled items and why component lines appear in API but not Excel.

Price history / scheme:

- `COM_5013.APP_4_PRICELOG` (contains `PRICE_SCHEME_ENUM`)
- `COM_5013.APP_4_PRICECHANGEITEM`
  - Might indicate which price tier the report uses per date/sales type.

Customer price scheme:

- `COM_5013.APP_4_CUSTOMER` (has `PRICE_SCHEME`, `DEFAULT_SALES_TYPE`)
- `COM_5013.APP_4_CUSTOMERTYPE` (has `INT_PRICE_SCHEME`, `DEFAULT_SALES_TYPE`)
  - Could influence which price tier is applied.

Tables confirmed empty in Xilnex:

- `COM_5013.APP_4_PRODUCTDICTIONARYMAPPING`
- `COM_5013.APP_4_COMBOITEM`
- `COM_5013.APP_4_MENUDEPARTMENT`
- `COM_5013.APP_4_CLIENTPRICE`
- `COM_5013.APP_4_CLIENTGROUPPRICE`

## Next Actions

- Add `APP_4_ORDER` and `APP_4_ORDERITEM` to the replica schema list.
- Create migrations for `dbo.com_5013_APP_4_ORDER` and `dbo.com_5013_APP_4_ORDERITEM`.
- Replicate order tables for validation against Product Mix output.

Order tables 2025 check:

- Ran `replicate_all_sales_data.py` for APP_4_ORDER + APP_4_ORDERITEM (2025-01-01 to 2025-10-31) and every month returned 0 rows.
- Checked Xilnex source counts/date ranges:
- `COM_5013.APP_4_ORDER`: 4 rows total, `DATETIME__ORDER_DATE` range `2020-03-23` to `2020-09-30`.
- `COM_5013.APP_4_ORDERITEM`: 3 rows total, `ORDER_DATE` is `varchar` (values like `23/03/2020`).
- Result: no 2025 data in either table, so not useful for Product Mix 2025 replication.

Menu tables date signal check:

- `COM_5013.APP_4_MENUPROFILE`: `DATETIME_MODIFIED` has 2025 values (max `2025-12-29`).
- `COM_5013.APP_4_MENUITEMOUTOFSTOCK`: `DATETIME__DATESTART`/`DATETIME__DATEEND` have 2025 values (max `2025-07-13` / `2025-12-31`).
- No date columns (treat as reference full-table): `APP_4_MENUPROFILEMAPPING`, `APP_4_MENUMAINCATEGORY`, `APP_4_MENUSUBCATEGORY`, `APP_4_MENUITEMMODIFIER`.

Menu tables replication + Product Mix rerun:

- Menu tables replicated into DW. Verified sample counts (MENUPROFILE ~58k, MENUPROFILEMAPPING ~121k, MENUMAINCATEGORY ~2.6k, MENUSUBCATEGORY ~53k, MENUITEMMODIFIER ~65k, MENUITEMOUTOFSTOCK ~2.3M).
- Updated Product Mix query to use menu tables. Initial filter using MENUSUBCATEGORY returned 0 rows because `SALESITEM.ITEM_CODE` does not match `APP_4_ITEM.ITEM_CODE`; it matches `APP_4_ITEM.ID` instead.
- Switched mapping to use `APP_4_MENUITEMOUTOFSTOCK.ITEM_ID` as menu mapping (location + global) and keep MENUSUBCATEGORY as fallback for group/category.
- Re-ran Product Mix comparison for 2025-08-31:
  - API entries: 30,822
  - Xilnex entries: 45,981
  - Matching: 2
  - Mismatching: 110
  - Only in API: 30,710
  - Only in Xilnex: 45,869
- Remaining patterns: category naming differences (punctuation/casing like `Side Orders.` vs `SIDE ORDERS`) and `net_sold_price_ex_tax` appears tax-inclusive (e.g., API 4.9 vs XN 4.62). Next fix: compute `net_sold_price_ex_tax = DOUBLE_SUB_TOTAL - DOUBLE_TOTAL_TAX_AMOUNT`, `net_sold_price = DOUBLE_SUB_TOTAL`.

Net/tax fix rerun:

- Updated Product Mix to use `net_sold_price_ex_tax = DOUBLE_SUB_TOTAL - DOUBLE_TOTAL_TAX_AMOUNT`, `net_sold_price = DOUBLE_SUB_TOTAL`.
- Re-ran Product Mix comparison for 2025-08-31:
  - API entries: 30,822
  - Xilnex entries: 45,981
  - Matching: 67
  - Mismatching: 45
  - Only in API: 30,710
  - Only in Xilnex: 45,869
- Remaining pattern: category naming mismatches (punctuation/casing) still drive most “only in” entries.

Category normalization rerun:

- Normalized category casing and trimmed trailing dots.
- Re-ran Product Mix comparison for 2025-08-31:
  - API entries: 30,612
  - Xilnex entries: 45,981
  - Matching: 60
  - Mismatching: 39
  - Only in API: 30,513
  - Only in Xilnex: 45,882

Packaging fee investigation (qty mismatch):

- Focus store: MB BANDAR BARU SELAYANG (2025-08-31).
- Packaging fee items in DW (`APP_4_ITEM`): `Packaging Fee` (14950475), `PACKAGING FEES` (14950476), `Packaging Fee Grab` (17920102).
- DW salesitem counts (COMPLETED + DELIVERY) match API: Packaging Fee = 23, Packaging Fee Grab = 65.
- Menu mapping filter is not dropping rows (all packaging fee rows have menuitem mapping for this store).
- No packaging fee rows in other sales statuses; no extra item codes with “Packaging Fee” name.
- Sales header business date matches sales date for this store/date (no mismatch).
- Conclusion: Xilnex Excel counts (29/74) are higher than DW data; likely missing rows in DW or Xilnex uses a different source/date logic. Tried querying Xilnex directly but connection blocked due to non-whitelisted IP.

Packaging fee follow-up:

- Re-tried Xilnex direct query with retry loop; still blocked by firewall (IP not whitelisted).
- Menu category check (MB BANDAR BARU SELAYANG, 2025-08-31): `DELIVERY - PACKAGING FEE` category includes item IDs 14950475 (Packaging Fee), 17920102 (Packaging Fee Grab), and 14950860 (SYOK10-RM5 OFF). Only first two appear in salesitems that day (qty 23 and 65).
- No voided packaging fee rows for the date/location.

Packaging fee deep dive (Xilnex direct access restored):

- Connected to Xilnex (whitelisted IP). For MB BANDAR BARU SELAYANG, 2025-08-31:
  - `APP_4_SALESITEM` (no status filter): Packaging Fee qty 23, Packaging Fee Grab qty 65 (same as API/DW).
  - Filtering on `DATETIME__BUSINESS_DATE` yields the same 23/65.
  - `DATETIME__DELIVERED_DATETIME` is NULL for packaging fee rows (no alternate delivery-date bucket).
  - `ORDER_SOURCE`/`DELIVERY_TYPE` in `APP_4_SALESITEM`: Packaging Fee Grab only in LOCAL/GRAB FOOD (65), Packaging Fee only in LOCAL/SHOPEE FOOD (23).
- `APP_4_SALES` header charges (`DOUBLE_DELIVERYCHARGEAMOUNT`, `DOUBLE_SERVICECHARGE_AMOUNT`) are 0 for completed delivery orders (no hidden charge source).
- `APP_4_ORDERITEM` still only has 2020 dates; no 2025 order data in Xilnex.
- `APP_4_DELIVERY_INTEGRATION_TRANSACTION` returns 0 rows for store/date.
- `APP_4_SALESITEM` category `DELIVERY - PACKAGING FEE` includes promo items (HOT DEALS - GRAB RM2 OFF qty 3, HOT DEALS - GRAB RM3.83 OFF qty 28), but Excel shows only Packaging Fee lines.
- `APP_4_VOIDSALESITEM` has packaging fee rows on 2025-08-31 (item 14950475 qty 24, item 17920102 qty 74) but `SALES_NO` is 0 and `SALESITEM_ID`/`SALESITEMID` are NULL, so cannot link to a store; not usable for per-store reconciliation.

Schema scan for additional Product Mix-related tables (empty / 2025 data check):

Has 2025 data:

- `COM_5013.APP_4_MENUITEMAVAILABILITYCONFIG` (2025 data in `DATETIMEUTC_DATEFROM`)
- `COM_5013.APP_4_CHANGEPRICELOG` (2025 data in `DATETIMEUTC_SALES_DATE`)
- `COM_5013.APP_4_PRICELOG` (2025 data in `DATETIME`)
- `COM_5013.APP_4_REDEMPTIONTYPE` (2025 data in `START_DATE`)

Non-empty but no 2025 data (mostly reference/config):

- `COM_5013.APP_4_MENUDYNAMICITEM` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_MENUITEMAVAILABILITYLOCATION` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_MENUITEMAVAILABILITYMAPPING` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_MENUITEMAVAILABILITYORDERSOURCE` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_MENUPROFILESOURCE` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_QUICKITEMPROFILE` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_QUICKITEMPROFILEMAPPING` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_PRICECHANGEITEM` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_ADVANCEDISCOUNT` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_PROMOTIONSETTING` (`CREATION_DATE`/`START_DATE`/`END_DATE`, no 2025 hits)
- `COM_5013.APP_4_PROMOITEM` (only `UPDATE_TIMESTAMP`)
- `COM_5013.APP_4_PROMORULE` (only `UPDATE_TIMESTAMP`)

Non-empty but no 2025 data (transactional / historical):

- `COM_5013.APP_4_SALESORDERITEM` (`DATETIME__SALES_DATE`/`SALES_DATE` present, no 2025 hits)
- `COM_5013.APP_4_SALESORDER` (`DATETIME__SALES_DATE`/`SALES_DATE` present, no 2025 hits)

Empty tables:

- `COM_5013.APP_4_MENUBRANCHASSORTMENT`
- `COM_5013.APP_4_MENUITEMAVAILABILITYTIMECONFIG`
- `COM_5013.APP_4_TABLEAREAMENUPROFILEMAPPING`
- `COM_5013.APP_4_API_PRODUCTITEM`
- `COM_5013.APP_4_API_PRODUCT_CATEGORY`
- `COM_5013.APP_4_API_PRODUCT_SUB_CATEGORY`
- `COM_5013.APP_4_API_PRODUCTITEMTAG`
- `COM_5013.APP_4_API_PRODUCTTAG`
- `COM_5013.APP_4_ECOMM_PRODUCT_TAXONOMY`
- `COM_5013.APP_4_SALESDELIVERY`
- `COM_5013.APP_4_DELIVERY_INTEGRATION_TRANSACTION`

Direct Xilnex data check (2025 coverage) for candidate tables:

- `COM_5013.APP_4_MENUITEMAVAILABILITYCONFIG`: 59 rows total, all 2025 (min/max `2025-09-07` → `2025-09-10`). Columns include `ITEM_ID`, `DATETIMEUTC_DATEFROM/TO`, day-of-week flags. No outlet/order-source mapping inside table.
- `COM_5013.APP_4_CHANGEPRICELOG`: 2 rows total, both 2025 (`2025-11-20` only). Likely too sparse for Product Mix.
- `COM_5013.APP_4_PRICELOG`: 664,702 rows total; 190,944 rows in 2025. Date range `2018-09-21` → `2025-12-24`. Contains `ITEM_ID`, `LOCATION_ID`, `PRICE_SCHEME_ENUM`, price history fields.
- `COM_5013.APP_4_REDEMPTIONTYPE`: 822 rows total; 179 rows in 2025. Contains promo/discount definitions (`ITEM_ID1/2/3`, `DOUBLE_DISCOUNT_*`, `START_DATE/END_DATE`).

Decision:

- Add `APP_4_MENUITEMAVAILABILITYCONFIG` and `APP_4_PRICELOG` to replica schema + migrations for further Product Mix investigation.
