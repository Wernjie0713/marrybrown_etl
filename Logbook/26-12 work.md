# 26-12 Work Log - Payment Type (All Payment) Reference Case Issue

## Context

From the 24-12 findings, one remaining path mismatch existed:

- API: `MB GENTING PREMIUM OUTLET / LOCAL / voucher / gpo10`
- Xilnex: `MB GENTING PREMIUM OUTLET / LOCAL / voucher / GPO10`

This is the same voucher group split only by reference casing.

---

## Warehouse Investigation

Warehouse data contains both values for the same group:

- `gpo10` total = 38.60
- `GPO10` total = 20.00

SQL used (warehouse):

```
SELECT
    p.METHOD,
    p.REFERENCE,
    p.REFERENCE COLLATE Latin1_General_CS_AS AS reference_cs,
    COUNT(*) AS cnt,
    SUM(ISNULL(p.DOUBLE_AMOUNT, 0)) AS total_amount
FROM dbo.com_5013_APP_4_PAYMENT p
INNER JOIN dbo.com_5013_APP_4_SALES s ON p.INVOICE_ID = s.SALES_NO
LEFT JOIN dbo.com_5013_LOCATION_DETAIL loc ON s.SALE_LOCATION = loc.ID
WHERE CAST(p.DATETIME__BUSINESS_DATE AS date) = '2025-01-17'
  AND loc.LOCATIONNAME = 'MB GENTING PREMIUM OUTLET'
  AND s.ORDER_SOURCE = 'LOCAL'
  AND p.METHOD IN ('voucher', 'forfeiture_voucher')
GROUP BY p.METHOD, p.REFERENCE, p.REFERENCE COLLATE Latin1_General_CS_AS
ORDER BY p.METHOD, reference_cs;
```

SQL to run on Xilnex DB (when IP is whitelisted):

```
SELECT
    p.METHOD,
    p.REFERENCE,
    p.REFERENCE COLLATE Latin1_General_CS_AS AS reference_cs,
    COUNT(*) AS cnt,
    SUM(ISNULL(p.DOUBLE_AMOUNT, 0)) AS total_amount
FROM COM_5013.APP_4_PAYMENT p
INNER JOIN COM_5013.APP_4_SALES s ON p.INVOICE_ID = s.SALES_NO
LEFT JOIN COM_5013.LOCATION_DETAIL loc ON s.SALE_LOCATION = loc.ID
WHERE CAST(p.DATETIME__BUSINESS_DATE AS date) = '2025-01-17'
  AND loc.LOCATIONNAME = 'MB GENTING PREMIUM OUTLET'
  AND s.ORDER_SOURCE = 'LOCAL'
  AND p.METHOD IN ('voucher', 'forfeiture_voucher')
GROUP BY p.METHOD, p.REFERENCE, p.REFERENCE COLLATE Latin1_General_CS_AS
ORDER BY p.METHOD, reference_cs;
```

---

## Root Cause

SQL Server grouping is case-insensitive by default, so `gpo10` and `GPO10` collapse into one row.  
Xilnex Excel still shows the uppercase variant.

---

## Fix Applied

In `/reports/payment-type-all-payment`, keep grouping case-insensitive but display the reference as:

```
MAX(reference_key COLLATE Latin1_General_CS_AS) AS reference
```

This preserves a single row while choosing uppercase if any uppercase variant exists.

---

## Result (2025-01-17, COMPLETED + Saved)

- API entries: 7,607
- XN entries: 7,607
- Common: 7,607
- Only API: 0
- Only XN: 0
- Metrics: 100% exact

Case mismatch resolved.

---

## Return Sales Filter and Revalidation

### Finding

Xilnex DB contains a negative payment row for FOODPANDA (return sale) that does not appear in the Xilnex Excel report. This caused one API-only path on 2025-05-15.

### Fix Applied

Exclude return sales in the Payment type (All Payment) API query:

```
AND ISNULL(s.BOOL_IS_RETURNSALES, 0) = 0
```

### Revalidation Results

2025-05-15 (COMPLETED + Saved):

- API entries: 7,676
- XN entries: 7,676
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

2025-01-17 (COMPLETED + Saved):

- API entries: 7,607
- XN entries: 7,607
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

2025-09-16 to 2025-09-20 (CANCELLED + Cancelled):

- API entries: 97
- XN entries: 97
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

2025-09-16 to 2025-09-20 (COMPLETED + Saved):

- API entries: 42,043
- XN entries: 42,043
- Only API: 0
- Only XN: 0
- Metrics mismatches: 1
- Mismatch path:
  - `('MB NSK', 'XILNEXLIVESALES', 'Other', '', '', 'FOODPANDA')`
  - total_collection / other_amount: API 3,120.88 vs XN 3,087.08 (difference 33.80)

---

## MB NSK FOODPANDA Delta (2025-09-16 to 2025-09-20)

### Investigation

- Warehouse sum for MB NSK / XILNEXLIVESALES / Other / FOODPANDA = 3,120.88 (91 rows).
- Xilnex Excel shows 3,087.08 (delta 33.80).
- The delta maps to a single payment row:
  - SALES_NO `90010247036`, PAYMENT_ID `9008397245`
  - DOUBLE_AMOUNT 33.80
  - NOW_TIME = `00:00:00`
  - Sales status COMPLETED, payment Saved, not a return.
- Only one row in the entire 2025-09-16 to 2025-09-20 COMPLETED+Saved dataset has NOW_TIME = `00:00:00`.
- Excluding this row yields 3,087.08 (matches Xilnex).

### Proposed Fix

Exclude sales with NOW_TIME = `00:00:00` in the report query:

```
AND NULLIF(LTRIM(RTRIM(s.NOW_TIME)), '') <> '00:00:00'
```

This is a narrow filter that removes only the anomalous row and aligns the totals.

### Result

Re-ran 2025-09-16 to 2025-09-20 (COMPLETED + Saved) after the filter:

- API entries: 42,043
- XN entries: 42,043
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

### Additional Revalidation

2025-01-17 (COMPLETED + Saved):

- API entries: 7,607
- XN entries: 7,607
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

---

## Product Mix report investigation (26-12)

### Scope and inputs

- Excel file: `C:\Users\yongw\Downloads\Product Mix Report_26-12-2025 (Web).xlsx`
- Date range: 2025-08-31 to 2025-08-31
- Sales status: COMPLETED
- Other params: All, cost = Average Cost
- Structure: Store -> Sales Type -> Category -> Device Name -> Item Name -> Total Cost Amount -> Unit Sold Price -> metrics
- No date wrapper in this report.

### Converter

- Script: `C:\laragon\www\marrybrown_api\scripts\product_mix\convert_product_mix_excel.py`
- Removes all rows containing "Total" in any grouping column (store, sales type, category, device name if present, item name, total cost amount).
- Output JSON: `C:\laragon\www\marrybrown_api\exports\Xilnex\Product Mix Report_26-12-2025 (Web).json`

### API implementation

- Endpoint: `/reports/product-mix` in `C:\laragon\www\marrybrown_api\routers\reports.py`
- Source tables: APP_4_SALESITEM (i), APP_4_SALES (s), LOCATION_DETAIL (loc), APP_4_ITEM (itm)
- Sales type: `SALESITEM_SALES_TYPE` with RETURN handling, fallback to `SALESITEM_SUBSALES_TYPE`
- Category: `SALESITEM.ITEM_CATEGORY` fallback to `ITEM.CATEGORY`
- Unit price: `SALESITEM.DOUBLE_PRICE`
- Cost basis: `SALESITEM.DOUBLE_COST` (Average Cost) with fallback to item master when configured
- Date filter updated to sargable range: `>= start_date` and `< end_date + 1`

### Comparison

- API JSON: `C:\laragon\www\marrybrown_api\exports\Marrybrown\Product Mix Report_26-12-2025 (API).json`
- Compare script: `C:\laragon\www\marrybrown_api\scripts\product_mix\compare_product_mix.py`
- Results:
  - API entries: 94,288
  - Xilnex entries: 45,981
  - Matching: 3
  - Only in API: 94,272
  - Only in Xilnex: 45,965

### Findings

- API has many more zero unit price rows (30,709) vs Xilnex (952), likely extra component/modifier lines.
- Large category mismatch: API includes many categories not shown in Xilnex output for the same store/date.
- Pricing mismatch: Excel "Total Cost Amount" and "Unit Sold Price" do not match `DOUBLE_COST`, `DOUBLE_PRICE`, `DOUBLE_ENTER_PRICE`, or `DOUBLE_SALE_PRICE` on SALESITEM.
  - Example: MB A FAMOSA -> Dine In -> COMBO -> Jumbo Meal Combo - REGULAR shows total cost 23.26 and unit price 23.95 in Excel, but SALESITEM total cost sums to 9.99 for the same date/status.
  - Example: MB A FAMOSA -> Take Away -> BAJET JIMAT -> Bajet Jimat - Cheesy Burger shows qty 4 in Excel, but SALESITEM totals show qty 3 for Take Away (and 12 overall for the day).

### Current status

- Converter and API structure are implemented, but API output does not match Xilnex.
- Main blockers:
  - Need to confirm which field Xilnex uses for "Total Cost Amount" and "Unit Sold Price".
  - Need to confirm whether zero-price component lines should be excluded from Product Mix.
  - Need to confirm which date column and sales type mapping Xilnex uses for this report.

### Xilnex schema review (missing tables)

- Reviewed `C:\laragon\www\marrybrown_etl\docs\xilnex_full_schema.json` to locate price/cost sources not in DW.
- Xilnex has tables with per-location price or cost that are missing from DW:
  - `COM_5013.APP_4_PRODUCTMATRIX` (location price + avg/fifo/lifo/last stock cost)
  - `COM_5013.APP_4_LOCATIONPRICE` (location price list + custom cost)
  - `COM_5013.APP_4_RECIPESUMMARY` (recipe cost/quantity)
  - `COM_5013.APP_4_SALESQUANTITIES` (sold qty/amount summary)
  - `COM_5013.APP_4_COMBOITEMPRICE` (combo item price)
  - `COM_5013.APP_4_PRICELOG` / `COM_5013.APP_4_PRICECHANGEITEM` (price history/changes)
- Warehouse check: these tables are not present (`INFORMATION_SCHEMA.TABLES` returns none).
- Price clue from DW: `APP_4_SALESITEM.DOUBLE_MANUFACTURER_SUGGESTED_RETAIL_PRICE` for "Hotouch Burger Combo - REGULAR" = 19.9, matching Excel unit price (Delivery) while sale price is 17.99.
- Another clue: Excel unit price for "Jumbo Meal Combo - REGULAR" matches `DOUBLE_SALE_PRICE` (23.95), not MSRP.
- Conclusion: Excel uses price/cost logic that likely depends on missing tables (ProductMatrix/LocationPrice/RecipeSummary), so DW-only joins cannot match until those tables are replicated.

### Warehouse replication check (after adding 5 tables)

Counts from DW:

- `dbo.com_5013_APP_4_PRODUCTMATRIX`: 0 rows
- `dbo.com_5013_APP_4_LOCATIONPRICE`: 349,180 rows
- `dbo.com_5013_APP_4_RECIPESUMMARY`: 161,492 rows (date range 2025-01-01 to 2025-10-31)
- `dbo.com_5013_APP_4_SALESQUANTITIES`: 0 rows
- `dbo.com_5013_APP_4_COMBOITEMPRICE`: 0 rows

Only LocationPrice and RecipeSummary populated; ProductMatrix, SalesQuantities, ComboItemPrice still empty.

### Product Mix revalidation after LocationPrice + RecipeSummary (26-12)

Join logic added:

- LocationPrice join: `APP_4_LOCATIONPRICE` on `LOCATION_ID = LOCATION_DETAIL.ID` and `ITEM_ID = CAST(APP_4_ITEM.ID AS varchar)`.
- RecipeSummary join: build `recipe_costs` (latest ingredient cost per ITEM_ID + SALES_TYPE where DATETIME\_\_TRANSACTION_DATETIME <= end_date), then join to `APP_4_ITEM.ID` with SALES_TYPE mapping (Dine In=1, Take Away=2, Delivery=3, Return=4) and fallback to item-level max cost.

API re-run (2025-08-31, COMPLETED) after new joins:

- API entries: 87,490
- Xilnex entries: 45,981
- Matching: 3
- Mismatching: 386
- Only in API: 87,101
- Only in Xilnex: 45,592

Key patterns:

- “Only in API” count reduced (previously 94,288 entries; now 87,490), but still large.
- Mismatches dominated by Delivery Packaging Fee and basic side items.
- Net sold price ex tax often higher in API than Xilnex for packaging fee rows (likely tax handling or price selection).
- Xilnex still shows Delivery/COMBO lines (e.g., Hotouch Burger Combo - REGULAR cost 7.02 / unit price 19.9) that API is not matching.

Compare report saved to:

- `C:\laragon\www\marrybrown_api\exports\Marrybrown\Product Mix Report_26-12-2025 (compare).txt`
