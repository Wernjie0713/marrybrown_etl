# 26-12 Work Log - Payment Type (All Payment) Reference Case Issue

## Context

From the 24-12 findings, one remaining path mismatch existed:

- API: `MB GENTING PREMIUM OUTLET / LOCAL / voucher / gpo10`
- Xilnex: `MB GENTING PREMIUM OUTLET / LOCAL / voucher / GPO10`

This is the same voucher group split only by reference casing.

---

## Warehouse Investigation

Warehouse data contains both values for the same group:

- `gpo10` total = 38.60
- `GPO10` total = 20.00

SQL used (warehouse):

```
SELECT
    p.METHOD,
    p.REFERENCE,
    p.REFERENCE COLLATE Latin1_General_CS_AS AS reference_cs,
    COUNT(*) AS cnt,
    SUM(ISNULL(p.DOUBLE_AMOUNT, 0)) AS total_amount
FROM dbo.com_5013_APP_4_PAYMENT p
INNER JOIN dbo.com_5013_APP_4_SALES s ON p.INVOICE_ID = s.SALES_NO
LEFT JOIN dbo.com_5013_LOCATION_DETAIL loc ON s.SALE_LOCATION = loc.ID
WHERE CAST(p.DATETIME__BUSINESS_DATE AS date) = '2025-01-17'
  AND loc.LOCATIONNAME = 'MB GENTING PREMIUM OUTLET'
  AND s.ORDER_SOURCE = 'LOCAL'
  AND p.METHOD IN ('voucher', 'forfeiture_voucher')
GROUP BY p.METHOD, p.REFERENCE, p.REFERENCE COLLATE Latin1_General_CS_AS
ORDER BY p.METHOD, reference_cs;
```

SQL to run on Xilnex DB (when IP is whitelisted):

```
SELECT
    p.METHOD,
    p.REFERENCE,
    p.REFERENCE COLLATE Latin1_General_CS_AS AS reference_cs,
    COUNT(*) AS cnt,
    SUM(ISNULL(p.DOUBLE_AMOUNT, 0)) AS total_amount
FROM COM_5013.APP_4_PAYMENT p
INNER JOIN COM_5013.APP_4_SALES s ON p.INVOICE_ID = s.SALES_NO
LEFT JOIN COM_5013.LOCATION_DETAIL loc ON s.SALE_LOCATION = loc.ID
WHERE CAST(p.DATETIME__BUSINESS_DATE AS date) = '2025-01-17'
  AND loc.LOCATIONNAME = 'MB GENTING PREMIUM OUTLET'
  AND s.ORDER_SOURCE = 'LOCAL'
  AND p.METHOD IN ('voucher', 'forfeiture_voucher')
GROUP BY p.METHOD, p.REFERENCE, p.REFERENCE COLLATE Latin1_General_CS_AS
ORDER BY p.METHOD, reference_cs;
```

---

## Root Cause

SQL Server grouping is case-insensitive by default, so `gpo10` and `GPO10` collapse into one row.  
Xilnex Excel still shows the uppercase variant.

---

## Fix Applied

In `/reports/payment-type-all-payment`, keep grouping case-insensitive but display the reference as:

```
MAX(reference_key COLLATE Latin1_General_CS_AS) AS reference
```

This preserves a single row while choosing uppercase if any uppercase variant exists.

---

## Result (2025-01-17, COMPLETED + Saved)

- API entries: 7,607
- XN entries: 7,607
- Common: 7,607
- Only API: 0
- Only XN: 0
- Metrics: 100% exact

Case mismatch resolved.

---

## Return Sales Filter and Revalidation

### Finding

Xilnex DB contains a negative payment row for FOODPANDA (return sale) that does not appear in the Xilnex Excel report. This caused one API-only path on 2025-05-15.

### Fix Applied

Exclude return sales in the Payment type (All Payment) API query:

```
AND ISNULL(s.BOOL_IS_RETURNSALES, 0) = 0
```

### Revalidation Results

2025-05-15 (COMPLETED + Saved):

- API entries: 7,676
- XN entries: 7,676
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

2025-01-17 (COMPLETED + Saved):

- API entries: 7,607
- XN entries: 7,607
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

2025-09-16 to 2025-09-20 (CANCELLED + Cancelled):

- API entries: 97
- XN entries: 97
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

2025-09-16 to 2025-09-20 (COMPLETED + Saved):

- API entries: 42,043
- XN entries: 42,043
- Only API: 0
- Only XN: 0
- Metrics mismatches: 1
- Mismatch path:
  - `('MB NSK', 'XILNEXLIVESALES', 'Other', '', '', 'FOODPANDA')`
  - total_collection / other_amount: API 3,120.88 vs XN 3,087.08 (difference 33.80)

---

## MB NSK FOODPANDA Delta (2025-09-16 to 2025-09-20)

### Investigation

- Warehouse sum for MB NSK / XILNEXLIVESALES / Other / FOODPANDA = 3,120.88 (91 rows).
- Xilnex Excel shows 3,087.08 (delta 33.80).
- The delta maps to a single payment row:
  - SALES_NO `90010247036`, PAYMENT_ID `9008397245`
  - DOUBLE_AMOUNT 33.80
  - NOW_TIME = `00:00:00`
  - Sales status COMPLETED, payment Saved, not a return.
- Only one row in the entire 2025-09-16 to 2025-09-20 COMPLETED+Saved dataset has NOW_TIME = `00:00:00`.
- Excluding this row yields 3,087.08 (matches Xilnex).

### Proposed Fix

Exclude sales with NOW_TIME = `00:00:00` in the report query:

```
AND NULLIF(LTRIM(RTRIM(s.NOW_TIME)), '') <> '00:00:00'
```

This is a narrow filter that removes only the anomalous row and aligns the totals.

### Result

Re-ran 2025-09-16 to 2025-09-20 (COMPLETED + Saved) after the filter:

- API entries: 42,043
- XN entries: 42,043
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

### Additional Revalidation

2025-01-17 (COMPLETED + Saved):

- API entries: 7,607
- XN entries: 7,607
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

2025-05-15 (COMPLETED + Saved):

- API entries: 7,676
- XN entries: 7,676
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0

2025-09-16 to 2025-09-20 (CANCELLED + Cancelled):

- API entries: 97
- XN entries: 97
- Only API: 0
- Only XN: 0
- Metrics mismatches: 0
