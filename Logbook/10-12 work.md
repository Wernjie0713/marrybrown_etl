# 10-12 Work Log

## üìä Daily Sales (Details) API Implementation

### Goal

Implement a new Daily Sales Details API that replicates Xilnex's detailed daily sales report, with data grouped by Store ‚Üí Sales Type.

---

## ‚úÖ Completed Tasks

### 1. Created Daily Sales Detail API

**Endpoint:** `GET /reports/daily-sales-detail`

**Features:**

- Nested JSON response structure (Store ‚Üí Sales Type ‚Üí Metrics)
- Includes: `sales_amount`, `sales_amount_ex_mgst`, `profit_amount`
- Uses `COALESCE(SUBSALES_TYPE, SALES_TYPE)` for sales type classification
- Same filters as Summary API: date range, location_keys, sales_statuses

**Response Structure:**

```json
{
  "data": {
    "MB A FAMOSA": {
      "DINE IN": {
        "sales_amount": 2500.00,
        "sales_amount_ex_mgst": 2358.49,
        "profit_amount": 1200.00
      },
      "TAKE AWAY": { ... }
    }
  }
}
```

**Files Modified:**

- `routers/reports.py` - Added new endpoint and response models

---

### 2. Data Comparison with Xilnex

**Test Date:** 15-Oct-2025

**Comparison Files:**

- Our API: `exports/Marrybrown/15-10-25_DailySalesDetails.json`
- Xilnex: `exports/Xilnex/15-10-25_DailySalesDetails.json`

**Results:**

| Metric            | Value           |
| ----------------- | --------------- |
| MB stores         | 242             |
| Xilnex stores     | 242             |
| Store match       | 100% ‚úÖ         |
| Exact value match | 798/816 (97.8%) |
| Discrepancies     | 18 rows         |

**Key Finding:** 15 "Return" sales type rows exist in Xilnex but missing from our API.

---

### 3. Root Cause Investigation

**Investigation Method:**

```sql
SELECT SALES_TYPE, SUBSALES_TYPE, DOUBLE_TOTAL_AMOUNT, LOCATIONNAME
FROM APP_4_SALES s
WHERE DATETIME__SALES_DATE = '2025-10-15'
  AND SALES_TYPE = 'Return'
```

**Finding:**
Return transactions have BOTH fields populated:

```
SALES_TYPE='Return' | SUBSALES_TYPE='Delivery' | Amount=-26.70
```

**Problem:**
Our `COALESCE(SUBSALES_TYPE, SALES_TYPE)` logic gives priority to SUBSALES_TYPE.

When:

- `SALES_TYPE = 'Return'`
- `SUBSALES_TYPE = 'Delivery'`

Result: Shows as "Delivery" instead of "Return"

**Impact:**

- Return transactions are grouped into wrong sales type (Delivery/Take Away/etc.)
- No "Return" category appears in our API
- Value discrepancies in affected sales types

---

## ‚úÖ Fix Applied

**Logic Change:**
If `SALES_TYPE = 'Return'`, always use 'Return' regardless of SUBSALES_TYPE.

```sql
-- Before (incorrect)
COALESCE(NULLIF(SUBSALES_TYPE, ''), SALES_TYPE)

-- After (correct)
CASE
  WHEN UPPER(SALES_TYPE) = 'RETURN' THEN 'Return'
  ELSE COALESCE(NULLIF(SUBSALES_TYPE, ''), SALES_TYPE)
END
```

**Files Modified:**

- `routers/reports.py` - Updated SELECT and GROUP BY clauses

---

## ‚úÖ Verification Results - 100% Accuracy

| Date        | Status    | Stores | Combinations | Match Rate  |
| ----------- | --------- | ------ | ------------ | ----------- |
| 15-Oct-2025 | COMPLETED | 242    | 831          | **100%** ‚úÖ |
| 24-Aug-2025 | COMPLETED | 236    | 825          | **100%** ‚úÖ |
| 24-Aug-2025 | CANCELLED | 124    | 186          | **100%** ‚úÖ |

**Total:** 3 test cases, 1,842 store+type combinations verified with exact match.

---

## üìù Status

- ‚úÖ Daily Sales Detail API implemented and verified
- ‚úÖ Return transaction logic fixed
- ‚ö†Ô∏è JWT auth temporarily disabled for development (commented out, needs re-enabling for production)
- üöÄ **Daily Sales Detail API is production-ready**

---

## üìä EOD Sales Summary API Implementation

### Goal

Implement EOD (End of Day) Sales Summary API that replicates Xilnex's EOD Sales Summary report, with payment breakdown by store and sales type.

---

### API Specification

**Endpoint:** `GET /reports/eod-sales-summary`

**Parameters:**

- `start_date`, `end_date` (required)
- `location_keys` (optional)
- `sales_statuses` (optional, default: COMPLETED)
- `payment_status` (optional, new: filters on `APP_4_PAYMENT.STRING_EXTEND_3` = 'Saved' or 'Cancelled')

**Tables Used:**

- `APP_4_SALES` - Sales header (date, store, totals, tax, sales type)
- `APP_4_PAYMENT` - Payment breakdown (cash, card, voucher, ewallet)
- `LOCATION_DETAIL` - Store name lookup

**Response Structure (Nested JSON):**

```json
{
  "data": {
    "2025-10-10": {
      "MB STORE NAME": {
        "Dine In": { metrics... },
        "Return": {
          "Take Away": { metrics... }
        }
      }
    }
  }
}
```

**Metrics per row:**

- `sales_transaction_qty`, `total_sales`, `sales_net_amount`
- `sales_net_amount_ex_mgst`, `mgst_tax_amount`
- `cash_amount`, `other_amount`, `voucher_amount`, `card_amount`, `summary_total`

---

### Initial Comparison Results (2025-10-10)

| Metric            | Value           |
| ----------------- | --------------- |
| Total Comparisons | 857             |
| **Exact Match**   | **839 (97.9%)** |
| Far Off (‚â•1)      | 18              |

**Discrepancy Pattern:**

- 16 cases: Our API shows HIGHER values than Xilnex (mostly Delivery/Drive Thru)
- 2 cases: Return transactions exist in our API but missing in Xilnex JSON

**Sample Discrepancies:**
| Store | Sales Type | Our API | Xilnex | Diff |
|-------|------------|---------|--------|------|
| MB BANDAR SERI ALAM | Delivery | 5,448.15 | 4,737.75 | +710.40 |
| MB I-PARK KULAI | Delivery | 3,317.05 | 2,653.75 | +663.30 |
| MB MYDIN SEREMBAN 2 | Return > Take Away | -26.90 | 0.00 | 26.90 |

### üîç Discrepancy Investigation

#### Hypothesis 1: Date Field Difference ‚ùå

**Test:** Compare `DATETIME__SALES_DATE` vs `DATETIME__BUSINESS_DATE` against Xilnex export values.

**Results:**
| Store | Sales Type | Xilnex Export | SALES_DATE | BUSINESS_DATE |
|-------|------------|---------------|------------|---------------|
| MB BANDAR SERI ALAM | Delivery | 4,737.75 | 5,448.15 | 5,526.85 |
| MB I-PARK KULAI | Delivery | 2,653.75 | 3,317.05 | 3,111.80 |

**Conclusion:** Neither date field matches. Both return values HIGHER than Xilnex export.

---

#### Hypothesis 2: Payment Status Filter ‚ùå

**Test:** Check if filtering by `STRING_EXTEND_3 = 'Saved'` affects results.

**Results:**
| Store | No Filter | Saved Filter | Cancelled |
|-------|-----------|--------------|-----------|
| MB BANDAR SERI ALAM | 5,448.15 | 5,448.15 | 0.00 |
| MB I-PARK KULAI | 3,317.05 | 3,317.05 | 0.00 |

**Conclusion:** All payments have status "Saved". Filter has no effect on discrepancy.

---

#### Hypothesis 3: Time-Based Cutoff ‚úì PROMISING!

**Test:** Check if EOD reports have a time cutoff (e.g., transactions after 10 PM roll to next day).

**Results for MB BANDAR SERI ALAM > Delivery:**
| Cutoff Time | Total | Diff from Xilnex (4,737.75) |
|-------------|-------|----------------------------|
| Before 22:00 | 4,739.40 | **1.65** ‚úì VERY CLOSE! |
| Before 23:00 | 5,017.80 | 280.05 |
| Before 24:00 | 5,448.15 | 710.40 |

**Hourly Breakdown (MB BANDAR SERI ALAM > Delivery):**

- Hour 21:00: Cumulative = 4,739.40 (matches Xilnex 4,737.75 within RM2!)
- Late-night transactions (22:00-23:59) add RM708.75

**Conclusion:** Xilnex EOD reports likely have a **time-based cutoff around 21:00-22:00**. Transactions after this time may roll to the next day's report.

---

#### Hypothesis 4: EODLOGID Grouping ‚úì ROOT CAUSE FOUND!

**Test:** Check if transactions are grouped by `EODLOGID` and `DATETIME__BUSINESS_DATE`.

**Results for MB BANDAR SERI ALAM > Delivery (SALES_DATE = 2025-10-10):**
| EODLOGID | Business Date | TX Count | Total |
|----------|---------------|----------|-------|
| 17950435 | 2025-10-09 | 1 | 22.70 |
| 17950436 | **2025-10-10** | 32 | 1,120.75 |
| 900217397 | 2025-10-09 | 25 | 687.70 |
| 900217633 | **2025-10-10** | 107 | 3,617.00 |
| **GRAND TOTAL** | | 165 | 5,448.15 |

**If we filter by BUSINESS_DATE = 2025-10-10:**
1,120.75 + 3,617.00 = **4,737.75** ‚úÖ **EXACT MATCH with Xilnex Export!**

**Conclusion:** Xilnex EOD reports use `DATETIME__BUSINESS_DATE` for grouping, not `DATETIME__SALES_DATE`.

---

#### Final Verification: Excel Contains Multiple Dates

**Test:** Check original Excel for all dates included.

**Results:**
| Store | Date | Total Sales |
|-------|------|-------------|
| MB BANDAR SERI ALAM > Delivery | 2025-10-10 | 4,737.75 |
| MB BANDAR SERI ALAM > Delivery | 2025-10-11 | 789.10 |
| **Sum** | | **5,526.85** ‚úÖ |

**Conclusion:** The Excel export for "10-10 to 10-11" contains both dates. Our API query for 10-10 only returns 10-10 data, which is the correct behavior.

---

### ‚úÖ API Fix Applied

Changed `DATETIME__SALES_DATE` to `DATETIME__BUSINESS_DATE` in:

- `routers/reports.py` - EOD Sales Summary endpoint (lines 255 and 284)

**Verification:**

- Xilnex Direct Query (BUSINESS_DATE=10-10): 4,737.75
- Our DW Query (BUSINESS_DATE=10-10): 4,737.75
- Xilnex Export (10-10 row): 4,737.75 ‚úÖ **All match!**

---

### üìù Key Findings Summary

| Finding                 | Explanation                                                          |
| ----------------------- | -------------------------------------------------------------------- |
| Date field              | Use `DATETIME__BUSINESS_DATE` (not SALES_DATE)                       |
| Late-night transactions | Transactions after ~10 PM have BUSINESS_DATE = next day              |
| Xilnex EOD sessions     | Groups by EODLOGID which can span multiple business dates            |
| Our API behavior        | Strictly filters by requested date range (cleaner, more predictable) |

---

### üîÆ Behavior Difference: Our API vs Xilnex

| Aspect               | Our API                           | Xilnex Portal                           |
| -------------------- | --------------------------------- | --------------------------------------- |
| Query 10-10 to 10-10 | Returns only 10-10 data           | May return 10-10, 10-11, even 10-17     |
| Data accuracy        | ‚úÖ Matches source exactly         | ‚úÖ Correct (but grouped by EOD session) |
| Predictability       | ‚úÖ Returns exactly what requested | ‚ö†Ô∏è May include unexpected dates         |

---

### Investigation Scripts Created

| Script                                  | Purpose                                      |
| --------------------------------------- | -------------------------------------------- |
| `scripts/investigate_discrepancy.py`    | Compare Xilnex vs DW for specific store/type |
| `scripts/investigate_date_field.py`     | Compare SALES_DATE vs BUSINESS_DATE          |
| `scripts/investigate_payment_status.py` | Check payment status filter effect           |
| `scripts/investigate_time_cutoff.py`    | Check time-based cutoff hypothesis           |
| `scripts/investigate_eodlogid.py`       | Investigate EODLOGID grouping                |
| `scripts/verify_fix.py`                 | Verify BUSINESS_DATE fix                     |
| `scripts/check_excel_totals.py`         | Check Excel totals across all dates          |

---

### üìå Status: Investigation Complete

- ‚úÖ Root cause identified (BUSINESS_DATE vs SALES_DATE)
- ‚úÖ API fix applied (using DATETIME\_\_BUSINESS_DATE)
- ‚úÖ Data verified against Xilnex source
- ‚è∏Ô∏è Pausing for tomorrow - to continue with full validation
