# 23-12 Work Log - EOD Sales Summary Return Type Fix

## Issue Found

EOD Sales Summary API returned `Return -> Unknown` for some records (e.g., **MB I-PARK KULAI** on **2025-05-14**) even though Xilnex report shows `Return -> Delivery`.

### Example (Before)

```
"2025-05-14": {
  "MB I-PARK KULAI": {
    "Return": {
      "Unknown": {
        "sales_transaction_qty": -1,
        "total_sales": -140.79,
        "sales_net_amount": -140.79,
        "sales_net_amount_ex_mgst": -132.83,
        "mgst_tax_amount": -7.96,
        "cash_amount": 0,
        "other_amount": -140.79,
        "voucher_amount": 0,
        "card_amount": 0,
        "summary_total": -140.79
      }
    }
  }
}
```

## Root Cause

Both the return row and the original sale row have `SUBSALES_TYPE = NULL`. Xilnex still reports the return type as `Delivery`, so the API needs to fall back to the **original sale's `SALES_TYPE`** when sub-sales types are missing.

## Fix Applied

Updated EOD Summary SQL logic to add a fallback:

```
Return type fallback:
orig.SUBSALES_TYPE → s.SUBSALES_TYPE → orig.SALES_TYPE → 'Unknown'
```

## Result (After Restart)

```
"2025-05-14": {
  "MB I-PARK KULAI": {
    "Return": {
      "Delivery": {
        "sales_transaction_qty": -1,
        "total_sales": -140.79,
        "sales_net_amount": -140.79,
        "sales_net_amount_ex_mgst": -132.83,
        "mgst_tax_amount": -7.96,
        "cash_amount": 0,
        "other_amount": -140.79,
        "voucher_amount": 0,
        "card_amount": 0,
        "summary_total": -140.79
      }
    }
  }
}
```

## Status

- Fix confirmed after API restart.
- Return subtype now aligns with Xilnex output for affected records.

---

# Converter Finding - "Grand" Store Filter

## Issue Found

The Xilnex JSON export was missing:

- `2025-05-15 / MB GENTING GRAND HOTEL / Dine In`
- `2025-05-15 / MB GENTING GRAND HOTEL / Take Away`

These rows are present in the Excel file, but the converter skipped them.

## Root Cause

The converter was filtering out any **Store** that contains the word **"Grand"** to remove the "Grand Total" row. This also removed the legitimate store **MB GENTING GRAND HOTEL**.

## Fix Applied

- Keep the **"Grand"** filter only on the **Date** column (to remove the "Grand Total" row).
- For the **Store** column, only filter out **"Total"** rows.

## Status

- Converter now includes MB GENTING GRAND HOTEL rows.
- Structure comparison between API JSON and Xilnex JSON aligns after this fix.

---

# EOD Sales Summary - Summary Total Rounding Fix

## Fix Applied

Applied the same logic used in Sale Delivery:

- `summary_total = sum(payments) - sum(rounding)`

This uses `DOUBLE_ROUNDINGAMOUNT` from sales and subtracts it from the payment total.

## Result (15 May 2025, COMPLETED + Saved)

Structure match is now **100%** (820/820). Metrics improved:

- `summary_total`: **819/820 (99.88%)**
- `card_amount`: **819/820 (99.88%)**
- `cash_amount`: **819/820 (99.88%)**
- `voucher_amount`: **806/820 (98.29%)**
- `other_amount`: **378/820 (46.10%)** (still the main gap)

This confirms the rounding subtraction is useful and increases accuracy.

---

# EOD Sales Summary - Payment Method Mapping Fix

## Fix Applied

Reused the Sale Delivery payment mapping logic:

- `card_amount`: includes `card`, `debitcard`, `bank`
- `voucher_amount`: includes `voucher`, `forfeiture_voucher`
- `other_amount`: excludes `ewallet` and includes remaining methods (including `other`)

## Result (15 May 2025, COMPLETED + Saved)

Structure remains **100%** (820/820). Metrics improved significantly:

- `other_amount`: **820/820 (100%)** ✅
- `summary_total`: **819/820 (99.88%)**
- `card_amount`: **819/820 (99.88%)**
- `cash_amount`: **819/820 (99.88%)**
- `voucher_amount`: **806/820 (98.29%)**

Only 15 paths still have any metric diff (mostly voucher rounding + PETRON JALAN BADLISHAH).

---

# Voucher Amount Behavior (Xilnex)

## Pattern Found

Xilnex Excel **does not include** `forfeiture_voucher` in the **Voucher Amount** column.
It only sums `METHOD = 'voucher'`. The forfeiture voucher stays in `summary_total` only.

Confirmed by direct DB checks:

- **MB SEMPORNA / Dine In**: DB has `voucher 6.9 + forfeiture_voucher 3.1 = 10.0`, XN shows **6.9**
- **MB SUNWAY LAGOON / Dine In**: DB has **70.0** total, XN shows **68.0** (excludes 2.0 forfeiture)
- **MB DANAU KOTA / Dine In**: DB has **50.0**, XN shows **45.9** (excludes 4.1 forfeiture)

## Fix Applied

Updated EOD Sales Summary:

- `voucher_amount` now sums **only** `METHOD = 'voucher'`
- `forfeiture_voucher` remains part of `summary_total`

## Result (15 May 2025, COMPLETED + Saved)

Structure match: **100%** (820/820)

Metrics:

- `voucher_amount`: **820/820 (100%)** ✅
- `other_amount`: **820/820 (100%)** ✅
- `summary_total`: **819/820 (99.88%)**
- `card_amount`: **819/820 (99.88%)**
- `cash_amount`: **819/820 (99.88%)**

Only remaining mismatch: **MB PETRON JALAN BADLISHAH / 2025-05-16 / Take Away**.

---

# Payment Business Date vs Sales Business Date (PETRON JALAN BADLISHAH)

## Pattern Found

For `2025-05-16 / MB PETRON JALAN BADLISHAH / Take Away`, Xilnex report includes payments that are **tied to Business Date = 2025-05-15** even though the **sales' EODLOG business date is 2025-05-16**.

In Xilnex DB:

- Sales `215503192`, `215503193` (business_date=2025-05-15, sales_date=2025-05-16) → cash 449.75 (what API returned)
- Additional payments exist where `APP_4_PAYMENT.DATETIME__BUSINESS_DATE = 2025-05-15` but the sales' EODLOG business_date is 2025-05-16:
  - card = 82.00, cash = 21.90
  - These make the Xilnex report show cash 471.65, card 82.00, summary 553.65

This indicates the Xilnex report is filtering **payments** by `APP_4_PAYMENT.DATETIME__BUSINESS_DATE`, not by the sales EODLOG business_date.

## Fix Applied

Payment aggregation now filters by **payment business date**:

- `APP_4_PAYMENT.DATETIME__BUSINESS_DATE BETWEEN :start_date AND :end_date`
- Join payment → sales to display under sales_date/store/sales_type

## Result (15 May 2025, COMPLETED + Saved)

Full exact match achieved:

- Structure: **820/820**
- All metrics: **820/820 (100%)**

---

# sales_net_amount_ex_mgst Change (Aug 31 Test)

## Attempted Fix

To match `MB PD WATERFRONT / Dine In` (XN showed `sales_net_amount_ex_mgst = sales_net_amount`), I tried:

- `sales_net_amount_ex_mgst = SUM(net_amount)`

## Result (31 Aug 2025, COMPLETED + Saved)

Structure still **100%** (868/868), but accuracy dropped sharply:

- `sales_net_amount_ex_mgst`: **88/868 (10.14%)**
- 780 mismatches across stores (other fields remain 100%)

## Conclusion

Using net_amount globally is **not correct**. It fixes one store but breaks most others.
We should revert to the original formula (`total - tax`) and handle the PD WATERFRONT anomaly separately if needed.

---

# PD WATERFRONT sales_net_amount_ex_mgst Check (Xilnex DB)

## Finding

After IP whitelist, I queried Xilnex DB directly for:

`2025-08-31 / MB PD WATERFRONT / Dine In`

Xilnex DB result:

- `total_sales = 6480.2`
- `sales_net_amount = 6501.1`
- `mgst_tax_amount = 0`
- `sales_net_amount_ex_mgst = 6480.2`

This matches our API (`total - tax`) and **does NOT match the Xilnex Excel export**, which shows `sales_net_amount_ex_mgst = 6501.1`.

## Conclusion

The mismatch is **Excel report-side**, not data-side.
We will accept this for now and compare more reports. If this pattern repeats, we will investigate further.

---

# Return Payment Shift Attempt (16–20 Sep)

## Issue Found

Xilnex Excel showed an extra path:

- `2025-09-16 / MB NSK / Return / Delivery`

This row exists in Excel with `other_amount = -33.8`, but **no Return sales exist** on that date in DW or Xilnex DB.
The actual return sale is on **2025-09-17**, tied to the original delivery on **2025-09-16**.

## Attempted Fix

I tried to match Excel by:

- Grouping Return payments by the **original sale’s business_date**
- Emitting a **payment-only Return row** when no Return sales exist on that date

## Result

This made the comparison worse:

- New API-only row appeared: `2025-09-19 / MB KLUANG MALL / Return / Delivery`
- Metric diffs increased from **7** to **27** paths

## Conclusion

Reverted the change. Matching Excel’s return-payment shift needs a safer, narrower approach.

---

# Late-Sync Delivery Rows (16–20 Sep)

## Issue Found

Three Delivery paths were higher in Xilnex Excel by exactly **1 transaction** and a matching amount:

- `2025-09-18 / MB FALIM IPOH / Delivery` (+1, +31.50)
- `2025-09-18 / MB PARAGON MARKET JB / Delivery` (+1, +24.80)
- `2025-09-20 / MB PARAGON MARKET JB / Delivery` (+1, +65.90)

## Root Cause

DW showed a **late-synced sale** in each case:

- Sales date in range (e.g., 2025-09-18)
- EOD business_date far in the future (e.g., 2025-10-08 / 2025-10-27)

Xilnex Excel **includes** these by sales_date, while the API was only filtering by EOD business_date.

## Fix Applied

Added the late-sync OR clause to `/eod-sales-summary`:

```
sales_date BETWEEN start/end
AND eod_business_date > end_date + 1
```

## Result (16–20 Sep 2025)

All Delivery count/amount mismatches were resolved:

- `sales_transaction_qty`, `total_sales`, `sales_net_amount`, `sales_net_amount_ex_mgst`, `mgst_tax_amount` now **100% match**.

Remaining:

- One XN-only row: `2025-09-16 / MB NSK / Return / Delivery`
- Payment gaps on 2025-09-21 (cash/card/other/summary_total show 0 in API but non-zero in Excel)

---

# Payment Bucketing by Later Date (Reverted)

## Issue Found

There were small card/summary_total mismatches for 16–20 Sep, so I tried bucketing payments by the **later of sales_date vs payment_business_date** to align with Excel.

## Attempted Fix

Updated payment aggregation to use:

- `business_date = max(sales_date, payment_business_date)`

## Result

Comparison accuracy dropped sharply (many new cash/card/other/summary_total diffs).

## Conclusion

The change does **not** match Xilnex behavior for this report. Reverted back to filtering payments strictly by `APP_4_PAYMENT.DATETIME__BUSINESS_DATE`.
