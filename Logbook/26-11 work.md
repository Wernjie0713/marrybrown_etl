# Work Log: November 26, 2025

## Overview
This document records the data validation work performed on November 26, 2025, comparing the MarryBrown Portal with the Xilnex (POS source) Portal.

---

## 1. Data Validation Approach

### 1.1 Methodology
We adopted a **JSON-based comparison approach** for data validation:

1. **Export from My Portal**: Exported Daily Sales Report for April 1, 2019 to JSON format
   - File: `data validation/daily sales/my_portal.json`
   - Contains: 12 stores with `date`, `store_name`, `sales_amount`, `profit_amount`

2. **Export from Xilnex Portal**: Downloaded Excel file, then converted to JSON using Python script
   - Source: `Daily Sales (Summary)_26-11-2025 (Web).xlsx`
   - Script: `data validation/daily sales/extract_xilnex_excel.py`
   - Output: `data validation/daily sales/xilnex_portal.json`

3. **Comparison Scripts**: Created diagnostic Python scripts to investigate discrepancies
   - `investigate_apr2019.py` - Overall comparison and breakdown
   - `investigate_jitra_deep.py` - Deep dive into MB JITRA discrepancy
   - `check_datekey.py` - DateKey and SaleNumber pattern analysis
   - `find_root_cause.py` - Payment type and grain analysis
   - `compare_stores.py` - Side-by-side store comparison
   - `check_quantity.py` - Quantity value analysis

### 1.2 Why JSON-Based Approach?

| Benefit | Description |
|---------|-------------|
| **Verifiable extraction** | Can confirm data was parsed correctly before comparison |
| **Human-readable** | Easy to spot-check values manually |
| **Programmatic comparison** | Automate diffs, calculate percentages |
| **Reproducible** | Same files can be re-compared anytime |
| **Version control friendly** | Can track changes over time |

### 1.3 Database Connection
All diagnostic queries connected to local data warehouse using:
- **Connection**: `.env.local` credentials
- **Target**: `MarryBrown_DW` on `localhost`
- **Driver**: `ODBC Driver 17 for SQL Server`

---

## 2. API Filter Logic (What My Portal Uses)

The Daily Sales Report API endpoint uses the following SQL logic:

```sql
SELECT
    d.FullDate as date,
    l.LocationName as store_name,
    SUM(f.TotalAmount) as sales_amount,
    SUM(f.NetAmount - f.CostAmount) as profit_amount
FROM
    dbo.fact_sales_transactions f
JOIN
    dbo.dim_date d ON f.DateKey = d.DateKey
JOIN
    dbo.dim_locations l ON f.LocationKey = l.LocationKey
WHERE
    d.FullDate BETWEEN :start_date AND :end_date
    AND f.SaleType != 'Return'          -- Exclude return transactions
    AND f.SalesStatus = 'COMPLETED'     -- Only completed sales
GROUP BY
    d.FullDate, l.LocationName, l.LocationKey
ORDER BY
    d.FullDate DESC, l.LocationName
```

**Key Filters Applied:**
- `SaleType != 'Return'` - Excludes return/refund transactions
- `SalesStatus = 'COMPLETED'` - Only counts completed sales

**Columns Used:**
- `TotalAmount` - Tax-inclusive sale amount (for sales_amount)
- `NetAmount - CostAmount` - Profit calculation (revenue minus cost)

---

## 3. Data Validation Results (April 1, 2019)

### 3.1 Summary Statistics

| Metric | My Portal | Xilnex Portal | Difference |
|--------|-----------|---------------|------------|
| Total Stores | 12 | 12 | 0 |
| Total Sales | RM 55,327.36 | RM 37,507.55 | +RM 17,819.81 (+47.5%) |
| Matching Stores | 4 | 4 | - |
| Mismatched Stores | 8 | 8 | - |

### 3.2 Store-by-Store Comparison

#### Perfect/Near-Perfect Matches (4 stores)

| Store | My Portal | Xilnex | Difference |
|-------|-----------|--------|------------|
| MB CENTRAL I-CITY | RM 4,540.75 | RM 4,540.75 | RM 0.00 (0%) |
| MB CHANGLOON | RM 2,656.95 | RM 2,656.95 | RM 0.00 (0%) |
| MB TANJUNG BALAU | RM 756.50 | RM 756.50 | RM 0.00 (0%) |
| MB LANGKAWI AIRPORT | RM 2,812.11 | RM 2,812.10 | RM 0.01 (rounding) |

#### Mismatched Stores (8 stores)

| Store | My Portal | Xilnex | Difference | % |
|-------|-----------|--------|------------|---|
| **MB JITRA** | RM 23,006.92 | RM 5,999.35 | +RM 17,007.57 | **+283.5%** |
| MB ANGSANA | RM 3,385.65 | RM 2,938.05 | +RM 447.60 | +15.2% |
| MB PETRON PAROI OLD | RM 4,678.81 | RM 4,397.40 | +RM 281.41 | +6.4% |
| MB IOI KULAI | RM 3,437.58 | RM 3,257.35 | +RM 180.23 | +5.5% |
| MB IRDKL MALL | RM 1,109.77 | RM 1,051.20 | +RM 58.57 | +5.6% |
| MB GM KLANG | RM 3,645.29 | RM 3,539.50 | +RM 105.79 | +3.0% |
| MB IOI CITY MALL PUTRAJAYA | RM 2,486.85 | RM 2,411.20 | +RM 75.65 | +3.1% |
| MB CITTA MALL | RM 2,810.18 | RM 3,147.20 | -RM 337.02 | **-10.7%** |

---

## 4. Deep Dive: MB JITRA (+283.5% Discrepancy)

### 4.1 Initial Checks (All Passed)

| Check | Result | Notes |
|-------|--------|-------|
| Duplicate TransactionKeys | âœ… None | Primary key is unique |
| Duplicate grain (SaleNumber+ProductKey+PaymentTypeKey) | âœ… None | Grain is correct |
| Multiple payment types per sale | âœ… None | All 257 sales have 1 payment type |
| SaleType filtering | âœ… Correct | Only 'DINE IN' and 'TAKE AWAY' |
| SalesStatus filtering | âœ… Correct | Only 'COMPLETED' |
| IsFOC (Free of Charge) | âœ… None | No FOC items |

### 4.2 Column Value Comparison

```
TotalAmount (what Portal uses):  RM 23,006.92
NetAmount (pre-tax revenue):     RM 21,736.90
TaxAmount:                       RM 1,233.13
GrossAmount:                     RM 21,773.79
DiscountAmount:                  RM 36.89
Xilnex Target:                   RM 5,999.35

None of these match Xilnex!
```

### 4.3 Key Finding: Ratio Analysis

```
DB Total / Xilnex Total = 23,006.92 / 5,999.35 = 3.83x (approximately 4x)
```

### 4.4 Quantity Analysis (Critical Discovery!)

| Metric | MB JITRA | MB CENTRAL I-CITY |
|--------|----------|-------------------|
| Total Rows | 1,158 | 1,168 |
| Distinct Sales | 257 | 367 |
| **Total Quantity** | **5,965** | **1,446** |
| Rows per Sale | 4.51 | 3.18 |
| TotalAmount | RM 23,006.92 | RM 4,540.75 |

**MB JITRA has 4x more Quantity than MB CENTRAL I-CITY!**

### 4.5 SUM(TotalAmount / Quantity) Test

```
MB JITRA:
- SUM(TotalAmount):              RM 23,006.92
- SUM(TotalAmount/Quantity):     RM 5,652.57  <-- Very close to Xilnex!
- Xilnex Total:                  RM 5,999.35
- Difference:                    RM 346.78 (5.8%)
```

**This suggests Xilnex may be calculating at a per-unit level, not total line level.**

### 4.6 High Quantity Items

Many items have unusually high quantities:

| Product | Qty | TotalAmount | Notes |
|---------|-----|-------------|-------|
| Hotouch | 63 | RM 0.00 | Combo component (free) |
| Hotouch | 56 | RM 0.00 | Combo component (free) |
| MinuteMaid OJ (R) | 35 | RM 172.48 | Bulk order |
| Chick-A-Mix Combo | 21 | RM 350.42 | Bulk order |

These high-quantity items inflate the total when summed.

---

## 5. Root Cause Hypotheses

### Hypothesis 1: ETL Data Transformation Issue (High Confidence)
- The April 2019 data may have been extracted using an older ETL version
- Line items may have been duplicated or quantities inflated during transformation
- Evidence: 3.83x ratio matches the Quantity inflation pattern

### Hypothesis 2: Xilnex Uses Different Aggregation Level (Medium Confidence)
- Xilnex portal may aggregate at **sale header level** (not line item level)
- Or Xilnex may use a per-unit calculation
- Evidence: `SUM(TotalAmount/Quantity)` â‰ˆ Xilnex total

### Hypothesis 3: Time/Date Boundary Issues (Low Confidence)
- All TimeKey values are 0 (midnight), which is unusual
- Transactions near midnight could be assigned to different dates
- Evidence: TimeKey = 0 for all MB JITRA transactions

### Hypothesis 4: ETL Source Difference (Medium Confidence)
- Matched stores may have been extracted via different ETL run
- Mismatched stores may have different data quality issues
- Evidence: Some stores match perfectly, others don't

---

## 6. Files Created

| File | Purpose |
|------|---------|
| `data validation/daily sales/my_portal.json` | Exported data from My Portal |
| `data validation/daily sales/xilnex_portal.json` | Converted data from Xilnex Excel |
| `data validation/daily sales/extract_xilnex_excel.py` | Script to convert Xilnex Excel to JSON |
| `data validation/daily sales/investigate_apr2019.py` | Main diagnostic script |
| `data validation/daily sales/investigate_jitra_deep.py` | MB JITRA deep dive |
| `data validation/daily sales/check_datekey.py` | DateKey pattern analysis |
| `data validation/daily sales/find_root_cause.py` | Payment type and grain analysis |
| `data validation/daily sales/compare_stores.py` | Store-by-store comparison |
| `data validation/daily sales/check_quantity.py` | Quantity value analysis |

---

## 7. Recommended Next Steps

1. **Validate on Recent Data**
   - Run the same comparison on Oct/Nov 2025 data
   - Recent ETL runs should have cleaner data

2. **Re-run ETL for April 2019**
   - If old ETL had bugs, re-extracting may fix discrepancies
   - Use the current API-based ETL for consistency

3. **Request Xilnex Documentation**
   - Confirm what column/formula Xilnex portal uses for "Sales Amount"
   - Understand their aggregation level (header vs line item)

4. **Investigate Matched vs Mismatched Pattern**
   - Why do some stores match perfectly while others don't?
   - Is there a correlation with store size, transaction volume, or ETL batch?

---

## 8. Summary

| Finding | Status |
|---------|--------|
| Data validation approach established | âœ… Complete |
| JSON export/comparison pipeline working | âœ… Complete |
| Diagnostic scripts created | âœ… Complete |
| Root cause for MB JITRA identified | ðŸ” Quantity inflation (3.83x) |
| Root cause for other stores | ðŸ” Needs further investigation |
| Fix implemented | âŒ Pending |

**Key Insight**: The ~4x inflation in MB JITRA's sales amount correlates with inflated Quantity values (5,965 vs expected ~1,500). When we calculate `SUM(TotalAmount/Quantity)`, we get RM 5,652.57 which is within 6% of Xilnex's RM 5,999.35.

This suggests either:
1. The ETL is creating inflated Quantity values for some stores
2. Xilnex uses a different aggregation formula that we need to replicate

---

*Next session: Validate on recent data (Oct/Nov 2025) to confirm if this is an old ETL issue or a systemic problem.*


---

## 9. Plan Change & Follow-Up Actions (Post-Discussion with Industry Coach)

### 9.1 Summary of Decision
After reviewing the API limitations and business urgency with the Industry Coach, we agreed to **pause the optimized Star-Schema + API-based ETL approach** and switch to a **1:1 Xilnex replica plan** for Phase 1 (2024â€“2025 data only). The goal is to give Marrybrown immediate ownership of the live sales data, even if the schema remains poor in the short term.

### 9.2 Requirements from the New Plan
1. **Direct database replication** of key Xilnex tables into our SQL Server warehouse (sales, sales items, payments, products, locations, customers, promotions, staff, terminals).
2. **Daily ETL job at 2â€¯AM** that loads T-0 (yesterday) data and re-checks T-1 (previous day) for late fixes or voided transactions.
3. **Manual rerun command** to backfill a specific day or date range when needed.
4. **APIs** should first replicate Xilnexâ€™s **Sync Sales API** output from our warehouse; once that matches, extend to Daily Sales, EOD Summary, and Product Mix.
5. **IP whitelisting** with Xilnex must remain up to date so the replication process can run reliably from the cloud server.

### 9.3 Follow-Up Actions Completed Today
- **Documentation restructure**: Created `/docs` with new Markdown briefs (`PLAN.md`, `ETL.md`, `API.md`, `INFRA.md`, `HISTORY.md`, plus CLAUDE summary) so LLMs and future teammates understand the updated plan.
- **Codebase restructure**: Archived all legacy Star-Schema / API-based assets (`api_etl`, `direct_db_etl`, `docs`, `migrations`, `scripts`, `orchestration`, `tests`, `data validation`, `debug`, old READMEs, etc.) under `archive/legacy_api_pipeline/`.
- **Working tree cleanup**: Repository root now contains only files needed for the new 1:1 replica plan (env files, requirements, config scripts, new docs, work logs).
- **Schema references created**:
  - `docs/replica_schema.json` documents the key tables/columns we plan to replicate in Phase 1 (sales, payments, products, customers, outlets, loyalty, promotions, terminals).
  - `docs/xilnex_full_schema.json` is a comprehensive dump (598 tables) from `INFORMATION_SCHEMA`, generated via `scripts/dump_xilnex_schema.py` for future lookup without querying the live DB.
- **Replica tooling implemented**:
  - Added new migrations (`migrations/schema_tables/100_create_replica_tables.sql` and `110_create_replica_metadata_tables.sql`) to create 1:1 tables plus run-history metadata.
  - Implemented `scripts/export_and_load_replica.py` (bulk export â†’ Snappy Parquet â†’ SQL load) and `scripts/run_replica_etl.py` (Tâ€‘0/Tâ€‘1 orchestrator writing to `replica_run_history`).
  - Updated `docs/ETL.md` / `docs/INFRA.md` / `docs/HISTORY.md` with instructions for running the new workflow.

### 9.4 Next Steps
1. Scaffold new replication scripts (T-0/T-1 logic, manual CLI).
2. Draft SQL `MERGE` templates for each replicated table.
3. Implement Sync Sales API JOIN blueprint using raw tables.
4. Keep `/docs` updated as milestones progress.

*This section captures the plan pivot agreed on 26 Nov 2025 so future readers know why the project direction changed and where archived assets live.*


