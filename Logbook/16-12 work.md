# Work Log - December 16, 2025

## EOD Sales Summary Detail - Xilnex Splitting Behavior Fix

### Problem

Xilnex exports split transactions into multiple rows:

- **Empty Card Type row**: Contains `total_sales` but `card_amount = 0`
- **Card Type rows**: Contains `card_amount` but `total_sales = 0`

This caused 306 Xilnex-only entries in comparison (94.3% match rate).

### Solution

Added post-processing step in `convert_eod_detail_excel.py` to remove empty Card Type "sales summary" entries where:

1. `card_amount = 0` (just the sales summary)
2. Other Card Type entries exist for the same Store/Cashier group

### Code Change

**File:** `marrybrown_api/scripts/convert_eod_detail_excel.py`

Added `remove_empty_cardtype_summaries()` function after building the nested JSON:

- Traverses all Date → Store → Cashier → CardType hierarchies
- Removes empty Card Type leaf nodes where `card_amount = 0`
- Only removes if other Card Type entries exist (not orphan entries)

### Results

| Metric                            | Before | After     | Change    |
| --------------------------------- | ------ | --------- | --------- |
| Structure Match Rate              | 94.3%  | **97.6%** | **+3.3%** |
| Only in Xilnex                    | 306    | **80**    | **-226**  |
| 'The Cashier' in Xilnex-only      | 86     | **0**     | **-86**   |
| Empty Card Type summaries removed | -      | 4,572     | -         |

### Remaining 80 Xilnex-only Entries

Sample paths showing E-Wallet amount mismatches:

- `MB SKY AVENUE/Veronica Jane/TNGWALLET-RM/18.5/Dine In/1860`
- `MB IOI MALL PUCHONG/KHAIRINA/TNGWALLET-RM/22/Take Away/9690`
- `MB BUKIT BARU UTAMA/Esther Ann/BPAY MB000004/0/Dine In/21350`

### Entry Counts After Fix

| Source           | Count |
| ---------------- | ----- |
| API              | 5,236 |
| Xilnex (cleaned) | 3,326 |
| Common           | 3,246 |
| Only in API      | 1,990 |
| Only in Xilnex   | 80    |

---

## Investigation: Remaining 80 Discrepancies

### Root Cause: Computer Site ID Mismatch

**Example: MB SKY AVENUE / Veronica Jane / TNGWALLET-RM / 18.5 / Dine In**

| Source       | Computer Site ID |
| ------------ | ---------------- |
| **Database** | 900              |
| **Excel**    | 1860             |

The hierarchy matches until the Computer Site ID level, then they diverge.

### Payment Status Filter Test

Tested API with `payment_status=SAVED` filter to match Xilnex export:

```
Parameters: {
    "start_date": "2025-05-15",
    "end_date": "2025-05-15",
    "payment_status": "SAVED"
}
```

**Result:** Same 5,236 API entries, 97.6% match rate unchanged.

The payment_status filter doesn't affect the discrepancies.

### Conclusion

The 80 remaining Xilnex-only entries are due to **Computer Site ID differences** between:

- Our database (`APP_4_SALES.STRING_EXTEND_3`)
- Xilnex Excel export

This is a **data source difference** at the POS terminal level, not a code issue.

---

## Final Summary (May 15 Data)

| Metric                   | Value                             |
| ------------------------ | --------------------------------- |
| **Structure Match Rate** | **97.6%**                         |
| API entries              | 5,236                             |
| Xilnex entries (cleaned) | 3,326                             |
| Common entries           | 3,246                             |
| Only in API              | 1,990                             |
| Only in Xilnex           | 80 (Computer Site ID differences) |

---

## EODLOG Business Date Fix

### Problem

When querying for 2025-01-17 data, the API returned entries for 3 dates:

- 2025-01-17: 5,076
- 2025-01-18: 5,244 (should not be included!)
- 2025-01-19: 34 (should not be included!)

### Root Cause

Two issues in the SQL query:

1. **Output date used `SALES_DATE`** instead of EODLOG `BUSINESS_DATE`
2. **OR clause incorrectly included** sales with future BUSINESS_DATE

### Fix Applied

**File:** `marrybrown_api/routers/reports.py`

**Change 1 (line 498):** Use BUSINESS_DATE for output:

```sql
-- Before:
CAST(s.DATETIME__SALES_DATE AS date) AS sale_date

-- After:
CAST(e.DATETIME__BUSINESS_DATE AS date) AS sale_date
```

**Change 2 (lines 528-534):** Simplify filter:

```sql
-- Before:
AND (
    CAST(e.DATETIME__BUSINESS_DATE AS date) BETWEEN :start_date AND :end_date
    OR (
        CAST(s.DATETIME__SALES_DATE AS date) BETWEEN :start_date AND :end_date
        AND CAST(e.DATETIME__BUSINESS_DATE AS date) > DATEADD(day, 1, :end_date)
    )
)

-- After:
AND CAST(e.DATETIME__BUSINESS_DATE AS date) BETWEEN :start_date AND :end_date
```

### Results (January 17, 2025)

| Date       | Before | After  |
| ---------- | ------ | ------ |
| 2025-01-17 | 5,076  | 5,075  |
| 2025-01-18 | 5,244  | **30** |
| 2025-01-19 | 34     | 0      |

**Reduced extra date entries by 99.4%!**

### Comparison (January 17 Only)

| Metric                   | Value     |
| ------------------------ | --------- |
| API entries              | 5,075     |
| Xilnex entries           | 3,169     |
| Common                   | 3,057     |
| Only in API              | 2,018     |
| Only in Xilnex           | 112       |
| **Structure Match Rate** | **96.5%** |

---

## ⚠️ CRITICAL: EODLOG Date Logic (IMPORTANT!)

### Problem Discovered

When querying for Jan 17 data, the API was returning ALL Jan 18 business data (~5,244 entries) instead of just late Jan 17 data recorded on Jan 18 (~19 entries).

### The Correct Logic

| Concept           | Description                                                            |
| ----------------- | ---------------------------------------------------------------------- |
| **BUSINESS_DATE** | Which business day the sale belongs to (EOD session)                   |
| **SALES_DATE**    | When the transaction was physically recorded                           |
| **Late Sales**    | Sales recorded AFTER EOD cutoff but belonging to previous business day |

### Example

A sale made at 12:30 AM on Jan 18 might have:

- `SALES_DATE = 2025-01-18` (when recorded)
- `BUSINESS_DATE = 2025-01-17` (the EOD session it belongs to)

### What Xilnex Does (THE CORRECT APPROACH)

1. **FILTER by BUSINESS_DATE** - Only include requested business day's data
2. **DISPLAY by SALES_DATE** - Group/show by recorded date

When querying Jan 17:

- Include all where `BUSINESS_DATE = Jan 17`
- Display late sales under `SALES_DATE = Jan 18`

### The Fix

**Line 498 (eod-sales-summary-detail):**

```sql
-- FILTER by BUSINESS_DATE (line 528)
AND CAST(e.DATETIME__BUSINESS_DATE AS date) BETWEEN :start_date AND :end_date

-- DISPLAY by SALES_DATE (line 498)
CAST(s.DATETIME__SALES_DATE AS date) AS sale_date
```

### ⚠️ NEVER DO THIS

- DO NOT use BUSINESS_DATE for both filtering AND display
- DO NOT use the confusing OR clause that includes future business dates

---

## Final Verification - After Complete Fix

### API Call: Jan 17 Only (BUSINESS_DATE filter)

**Parameters:**

```
start_date: 2025-01-17
end_date: 2025-01-17
payment_status: SAVED
```

### Results

| Date       | API    | Xilnex | Notes               |
| ---------- | ------ | ------ | ------------------- |
| 2025-01-17 | 5,075  | 3,169  | Both have main data |
| 2025-01-18 | **30** | **19** | Late Jan 17 data ✅ |

### Comparison

| Metric                   | Value     |
| ------------------------ | --------- |
| Total API entries        | 5,105     |
| Total Xilnex entries     | 3,188     |
| Common entries           | 3,072     |
| Only in API              | 2,033     |
| Only in Xilnex           | 116       |
| **Structure Match Rate** | **96.4%** |

### Key Achievement

| Before Fix                          | After Fix               |
| ----------------------------------- | ----------------------- |
| Jan 18: **5,244** entries           | Jan 18: **30** entries  |
| (All Jan 18 business data included) | (Only late Jan 17 data) |

**EODLOG date logic now correctly matches Xilnex behavior!**

---

## Investigation: Empty Card Type Handling

### The Problem

API had **2,033 extra entries** that Xilnex didn't have. Investigation revealed these were **empty Card Type** entries.

### Root Cause Discovery

In the Excel, empty Card Type cells can mean TWO things:

1. **REAL empty Card Type** - Actual value (cash/no card payment)
2. **Merged cell / inherited** - Same as previous row (continuation row)

### Excel Structure (Example)

```
| Card Type    | E-Wallet  | Sales Type | <- After Total row = NEW section
| (empty)      | RM 0.00   | Delivery   | <- REAL empty Card Type
| (empty)      |           | Dine In    | <- Inherited empty (merged cell)
| RM 0.00 Total|           |            | <- Total row
| CARD-RM      | RM 0.00   | Dine In    | <- After Total = NEW section
| (empty)      |           | Take Away  | <- Inherited = CARD-RM (merged cell)
| RM 0.00 Total|           |            | <- Total row
| MAYBANKQR-RM | RM 22.50  | Take Away  | <- After Total = NEW section
| (empty)      | RM 61.10  | Dine In    | <- Inherited = MAYBANKQR-RM
```

### The "Total Row" Solution

**Rule**: Use "Total" rows as section boundaries.

- Row **after a Total row** = Start of NEW Card Type section
- If Card Type is **empty after Total** = REAL empty Card Type
- If Card Type is **empty NOT after Total** = Inherit from previous (merged cell)

### Implementation

**File:** `scripts/convert_eod_detail_excel.py`

```python
# Detect Total rows
df['_is_total_row'] = df.apply(is_total_row, axis=1)

# Row after Total = new section start
df['_is_section_start'] = df['_is_total_row'].shift(1).fillna(False)

# Forward-fill Card Type ONLY for non-section-start rows
df.loc[df['_is_section_start'], 'Card Type'] = df.loc[df['_is_section_start'], '_original_card_type']
```

### Results After Total Row Logic

| Metric      | Before (Remove Empty) | After (Total Row) |
| ----------- | --------------------- | ----------------- |
| XN entries  | 3,188                 | **5,154**         |
| API entries | 5,105                 | 5,105             |
| Common      | 3,072                 | **4,837**         |
| Only in API | 2,033                 | **268** ✅        |
| Only in XN  | 116                   | 317               |
| Match Rate  | 96.4%                 | 93.8%             |

### Key Improvement

**Only in API dropped from 2,033 to 268** - The converter now correctly distinguishes real empty Card Type from merged cells.

### Remaining Issue

317 XN-only entries, of which 202 have empty Card Type. These might be cases where:

- Total row detection didn't catch all section boundaries
- Some edge cases in the Excel structure

### Next Steps

Further investigation needed to understand the 202 empty Card Type entries in XN but not in API.

---

## Discovery: Xilnex Splitting Pattern

### Investigation

Checked 15 stores with empty Card Type in XN but not in API. User manually verified in Excel - confirmed ALL follow the same pattern.

### The Pattern (Confirmed by Excel)

| Card Type   | E-Wallet | Sales Type | Sales Amount | Card Amount |
| ----------- | -------- | ---------- | ------------ | ----------- |
| **(empty)** | RM 0.00  | Take Away  | **RM 7.20**  | RM 0.00     |
| CARD-RM     | RM 0.00  | Take Away  | RM 0.00      | **RM 7.20** |

**Empty Card Type** = Aggregated SALES for each Sales Type
**Specific Card Type** = PAYMENT breakdown (card_amount only)

### Example

For a sale of RM 18 paid with Card Type A (RM 12) and Card Type B (RM 6):

| Card Type | Sales Type | Sales   | Card Amount |
| --------- | ---------- | ------- | ----------- |
| (empty)   | Take Away  | RM 18   | RM 0.00     |
| Card A    | Take Away  | RM 0.00 | RM 12       |
| Card B    | Take Away  | RM 0.00 | RM 6        |

### Current API Issue

API combines sales and payments into one row per card_type:

```
CARD-RM / Take Away → Sales: RM 7.20, Card: RM 7.20
```

Xilnex splits them:

```
(empty) / Take Away → Sales: RM 7.20, Card: RM 0.00
CARD-RM / Take Away → Sales: RM 0.00, Card: RM 7.20
```

### Implementation Plan: SQL UNION Approach

**Query 1** - Sales Summary (Empty Card Type):

```sql
SELECT Date, Store, Cashier, '' AS card_type, SalesType,
       SUM(sales) AS total_sales, 0 AS card_amount
FROM sales
GROUP BY Date, Store, Cashier, SalesType
```

**Query 2** - Payment Details (Specific Card Type):

```sql
SELECT Date, Store, Cashier, card_type, SalesType,
       0 AS total_sales, SUM(card_amount) AS card_amount
FROM payments
GROUP BY Date, Store, Cashier, card_type, SalesType
```

**UNION ALL** both results to create the split pattern.

### Implementation Results

| Metric         | Before (Total Row) | After (UNION Split) |
| -------------- | ------------------ | ------------------- |
| XN entries     | 5,154              | 5,154               |
| API entries    | 5,105              | **5,298**           |
| Common         | 4,837              | **5,028**           |
| Only in API    | 268                | 270                 |
| Only in XN     | 317                | **126** ✅          |
| **Match Rate** | 93.8%              | **97.6%**           |

**Key Achievement**: Only in XN dropped from 317 to 126 - the split pattern now captures most empty Card Type entries.

### Remaining Discrepancies (126 entries)

| Difference Level | Count | Description                                           |
| ---------------- | ----- | ----------------------------------------------------- |
| Site ID diff     | 82    | Same path until Site ID, database has different value |
| E-Wallet diff    | 32    | Same Card Type, different E-Wallet Amount             |
| Sales Type diff  | 12    | Same Card Type + E-Wallet, different Sales Type       |

**Card Type distribution**: TNGWALLET-RM (46), MAYBANKQR-RM (21), VISA (14), CARD-RM (11), empty (11), RM-MASTER (8)

---

## Investigation: E-Wallet Aggregation Issue

### The Problem

32 of 126 XN-only entries had **E-Wallet amount differences**. Example:

| Store              | XN E-Wallet | API E-Wallets  |
| ------------------ | ----------- | -------------- |
| MB TAMAN MAJU JAYA | **58.5**    | [31.5, 27]     |
| MB GENTING GRAND   | **142.45**  | [20.95, 121.5] |

User verified in Excel: E-Wallet shows **aggregated** 58.5, not separate 31.5 and 27.

### Root Cause

API was grouping by `computer_site_id`, creating separate E-Wallet amounts per Site ID. Excel shows aggregated E-Wallet across all Site IDs for the same Cashier/Card Type/Sales Type group.

### Solution

Added **`ewallet_agg` CTE** to pre-aggregate E-Wallet amounts:

```sql
ewallet_agg AS (
    SELECT sale_date, store_name, cashier, card_type, sales_type,
           SUM(CASE WHEN METHOD = 'ewallet' THEN amount ELSE 0 END) AS total_ewallet
    FROM sales_base sb
    INNER JOIN payment_base pb ON pb.INVOICE_ID = sb.SALES_NO
    GROUP BY sale_date, store_name, cashier, card_type, sales_type
    -- Note: NO computer_site_id in GROUP BY
)
```

Then `payment_detail` joins to `ewallet_agg` to get the aggregated E-Wallet for hierarchy key.

### Results After E-Wallet Aggregation Fix

**Test Case Verified**: MB TAMAN MAJU JAYA / Nurin Amni / TNGWALLET-RM

- Before: `[31.5, 27]` (separate keys)
- After: `58.5` ✅ (aggregated)

| Metric         | Before Fix | After Fix | Change |
| -------------- | ---------- | --------- | ------ |
| Common         | 5,028      | **5,043** | +15    |
| Only in API    | 270        | **255**   | -15    |
| Only in XN     | 126        | **111**   | -15    |
| **Match Rate** | 97.6%      | **97.8%** | +0.2%  |

### Remaining 111 XN-only Entries

- ~82 are **Site ID differences** (data source issue - database has different Computer Site ID than Excel)
- Remainder are converter/data discrepancies

**Current Match Rate: 97.8%** ✅

---

## Additional Fix: Cashier Default Value

Changed cashier default from `'The Cashier'` to empty string `''` to match converter behavior:

```sql
-- Line 494 in reports.py
COALESCE(NULLIF(LTRIM(RTRIM(s.CASHIER)), ''), '') AS cashier
```

This aligns with the converter which also uses empty string for missing cashiers.
