# 17-12-2025 Work Log

## Summary

Investigated Site ID discrepancies. **ROOT CAUSE FOUND**: Xilnex Excel export transforms Site ID using proprietary logic.

---

## üéØ ROOT CAUSE DISCOVERED

### The Evidence

| Source              | Site ID for Veronica Jane SHOPEEPAY |
| ------------------- | ----------------------------------- |
| Xilnex Raw Database | **900**                             |
| Xilnex Excel Export | **1860**                            |
| Our Warehouse       | **900** ‚úÖ                          |
| Our API             | **900** ‚úÖ                          |

### Conclusion

**Xilnex Excel export applies internal logic** to calculate Computer Site ID that differs from the raw database value.

- ‚úÖ Our replication is 100% correct (matches Xilnex source)
- ‚úÖ Our API is 100% correct (returns database values)
- ‚ùå We CANNOT replicate Xilnex Excel's Site ID without their proprietary logic

---

## Comparison Results (Jan 17, 2025)

| Metric         | Value     |
| -------------- | --------- |
| API Entries    | 5,298     |
| XN Entries     | 5,154     |
| Common         | 5,043     |
| Only in XN     | 111       |
| Only in API    | 255       |
| **Match Rate** | **97.8%** |

### Discrepancy Breakdown

- **~206 API-only**: Site ID mismatch (API has 900, XN has 1860)
- **~111 XN-only**: Site ID mismatch (reverse direction)
- Both caused by Xilnex Excel's proprietary Site ID transformation

---

## Code Verification ‚úÖ

All fixes from Dec 15-16 are intact. No regressions found.

---

## Next Steps

- ‚úâÔ∏è **Sent email to Xilnex support** asking about Site ID transformation logic
- ‚è∏Ô∏è **Paused EOD Sales Summary Detail API** while waiting for reply
- üöÄ **Moving to develop another API** in the meantime

---

## Files Organized

Useful scripts moved to `scripts/eod_detail/`:

- `compare_eod_detail_12_12.py` - Main comparison script
- `compare_jan17.py` - Jan 17 comparison
- `convert_eod_detail_excel.py` - Excel converter
- `test_eod_detail_api.py` - API test script

---

## üöÄ New API: Sale Delivery (By Sales Type) Ex Tax Calculation

### Investigation

Analyzed the Xilnex report "Sale Delivery (By Sales Type) Ex Tax Calculation" to understand differences from EOD Sales Summary:

| Aspect             | EOD Sales Summary                                    | Sale Delivery By Sales Type                            |
| ------------------ | ---------------------------------------------------- | ------------------------------------------------------ |
| Date Field         | `SALES_DATE` for display, `BUSINESS_DATE` for filter | `BUSINESS_DATE` for both                               |
| Delivery Breakdown | Single "Delivery" category                           | By type: GrabFood, FoodPanda, Shopee Food, etc.        |
| Structure          | Flat per Sales Type                                  | Nested: Sales Type ‚Üí Sales Return Type ‚Üí Delivery Type |

### Implementation

Created new endpoint `GET /reports/sale-delivery-by-sales-type` in `reports.py`:

- Uses `EODLOG.DATETIME__BUSINESS_DATE` for both filter and display
- Delivery breakdown by specific `DELIVERY_TYPE`
- Consistent depth JSON structure with empty strings for missing levels

### Converter & Comparison Scripts

Created two new scripts:

- `scripts/convert_sale_delivery_excel.py` - Converts Xilnex Excel to JSON
- `scripts/compare_sale_delivery.py` - Compares API vs Xilnex JSON

### Comparison Results (Jan 17, 2025)

| Metric              | Value      |
| ------------------- | ---------- |
| API Entries         | 1,216      |
| Xilnex Entries      | 1,217      |
| Only in API         | 1          |
| Only in Xilnex      | 2          |
| **Structure Match** | **99.75%** |
| Matching Values     | 47         |
| Mismatching Values  | 1,168      |

### Key Discrepancy: `other_amount` for Delivery

For Delivery sales (GrabFood, FoodPanda, etc.):

- **API**: `other_amount = 0.0`
- **Xilnex**: `other_amount = full order amount`

Xilnex appears to categorize third-party delivery payments as "Other" while our SQL uses actual `APP_4_PAYMENT.METHOD`.

### Structural Discrepancies (3 entries)

1. **MB TAMAN MAJU JAYA Return**: API has `Sales Return Type = Delivery`, Xilnex has empty
2. **TESTING row**: Test data in Xilnex Excel with different date format

---

## üîç Investigating Structural Discrepancies

### MB TAMAN MAJU JAYA Return

**User confirmed**: Excel correctly shows `Return ‚Üí Delivery ‚Üí SHOPEE FOOD`. This is a **converter bug**, not API issue.

Metrics comparison (API vs Xilnex):

| Field                    | API    | Xilnex | Match |
| ------------------------ | ------ | ------ | ----- |
| sales_transaction_qty    | **1**  | **-1** | ‚ö†Ô∏è    |
| total_sales              | -22.5  | -22.5  | ‚úÖ    |
| sales_net_amount         | -22.5  | -22.5  | ‚úÖ    |
| sales_net_amount_ex_mgst | -21.23 | -21.23 | ‚úÖ    |
| mgst_tax_amount          | -1.27  | -1.27  | ‚úÖ    |
| other_amount             | 0      | -22.5  | ‚ö†Ô∏è    |
| summary_total            | -22.5  | -22.49 | ‚úÖ    |

**Issues found:**

- `sales_transaction_qty`: API uses positive count, Xilnex uses negative for returns
- `other_amount`: Same discrepancy pattern as other Delivery orders

### TESTING Store

**User confirmed**: Date format issue is a converter bug (picked up Total row's date).

Checked warehouse:

```
TESTING store exists in warehouse with 7 sales on Jan 17, 2025
```

The data is there, converter just failed to parse it correctly.

---

## üîß Fixes Applied

### 1. API: Negative `sales_transaction_qty` for Returns ‚úÖ

Changed SQL from `COUNT(*)` to:

```sql
SUM(CASE WHEN sales_type = 'Return' THEN -1 ELSE 1 END) AS sales_transaction_qty
```

### 2. Converter: Filter Business Date Total Rows ‚úÖ

Added filter for Business Date column containing "Total" - this fixed the TESTING store date format issue.

### Verification Results (After Fixes)

| Metric              | Value         |
| ------------------- | ------------- |
| API Entries         | 1,216         |
| Xilnex Entries      | 1,216 ‚úÖ      |
| Only in API         | 1             |
| Only in Xilnex      | 1             |
| **Structure Match** | **99.84%** ‚úÖ |
| Matching Values     | 47            |
| Mismatching Values  | 1,168         |

### Remaining Issue

**MB TAMAN MAJU JAYA Return**: Still 1 path difference

- API: `Return/Delivery/SHOPEE FOOD`
- Xilnex: `Return//SHOPEE FOOD` (empty Sales Return Type)

This is a converter issue - not reading Sales Return Type column properly for Return rows since it's not forward-filled.

### Remaining Discrepancies (Ignoring for now)

- `other_amount`: Systemic difference for Delivery orders
- `summary_total`: Minor rounding differences (~0.01-0.50)

---

## Status

- ‚úÖ Sale Delivery API implemented
- ‚úÖ `sales_transaction_qty` fixed - uses negative for returns
- ‚úÖ Converter Business Date filter fixed - 1,216 rows match API
- ‚ö†Ô∏è 1 remaining converter issue (Sales Return Type for Return rows)
- ‚è∏Ô∏è `other_amount` discrepancy - investigating later
- ‚è∏Ô∏è EOD Sales Summary Detail API still paused (waiting for Xilnex reply)

---

## üîç Investigating `other_amount` Discrepancy

### The Pattern

| Sales Type           | API other_amount | XN other_amount |
| -------------------- | ---------------- | --------------- |
| Delivery (FOODPANDA) | 0                | 106.54 (=total) |
| Dine In              | 159.8            | 0               |
| Take Away            | 0                | 0               |

### Database Investigation

Queried all payment METHOD values:

| METHOD      | Count         |
| ----------- | ------------- |
| 'card'      | 4,835,712     |
| 'cash'      | 4,639,797     |
| **'Other'** | **3,780,869** |
| 'ewallet'   | 740,068       |
| 'voucher'   | 150,197       |

### üéØ ROOT CAUSE FOUND

**Our API SQL uses `METHOD = 'ewallet'` for other_amount, but Delivery payments use `METHOD = 'Other'`!**

```sql
-- Current (WRONG):
CASE WHEN LOWER(p.METHOD) = 'ewallet' THEN p.DOUBLE_AMOUNT

-- Should be:
CASE WHEN LOWER(p.METHOD) IN ('ewallet', 'other') THEN p.DOUBLE_AMOUNT
```

Xilnex Excel likely includes both 'ewallet' and 'Other' in their "Other Amount" column, which is why:

- Delivery payments (METHOD='Other') ‚Üí XN shows in other_amount, API misses them
- Dine In ewallet (METHOD='ewallet') ‚Üí API shows in other_amount, but XN groups differently
