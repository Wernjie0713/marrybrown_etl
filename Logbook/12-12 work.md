# EOD Sales Summary - Continue Comparison Work

**Date:** December 12, 2025

## Objective

Continue comparing EOD Sales Summary API output with Xilnex reports using additional test data (May 15, 2025) and different status combinations.

---

## Test 1: Additional Status Combinations (Aug 1, 2025)

Tested 3 different Sales Status / Payment Status combinations:

| #   | Sales Status | Payment Status | Match Rate          | Notes                  |
| --- | ------------ | -------------- | ------------------- | ---------------------- |
| 1   | Cancelled    | Saved          | **100%** (171/171)  | Perfect match          |
| 2   | Cancelled    | Cancelled      | **100%** (171/171)  | Perfect match          |
| 3   | Completed    | Cancelled      | **99.0%** (856/865) | 9 Return discrepancies |

**Conclusion:** API handles Cancelled sales filters perfectly. Return exclusion issue persists across different filter combinations.

---

## Test 2: Completed + All Payment Status (May 15, 2025)

**Source:** `EOD Sales Summary Report_12-12-2025 (Web) (3).xlsx`

### Comparison Results

| Metric         | Value               |
| -------------- | ------------------- |
| Date           | May 15, 2025        |
| API Outlets    | 235                 |
| Xilnex Outlets | 235                 |
| Common Outlets | 235                 |
| API Total      | RM 1,216,858.97     |
| Xilnex Total   | RM 1,216,838.47     |
| Difference     | RM 20.50            |
| **Match Rate** | **99.0%** (803/811) |
| Discrepancies  | 8                   |

### Initial Discrepancies Identified

| Store            | API Value                  | Xilnex Value                       | Type              |
| ---------------- | -------------------------- | ---------------------------------- | ----------------- |
| MB TF TAMBUN     | Return>Take Away: -284.10  | Return>Birthday Take Away: -284.10 | Sub-type mismatch |
| MB PD WATERFRONT | Return>Drive Thru: -123.30 | Return Total: -143.80              | Converter issue   |
| MB PASIR PUTEH   | Return>Drive In: 0.00      | Return>Drive In: -33.30            | Missing return    |

---

## Manual Excel Verification Findings

After manually checking the Xilnex Excel file:

### 1. MB TF TAMBUN - Sub-type Categorization Issue

- **Excel shows:** `Return > Birthday Take Away` = -RM 284.10
- **API shows:** `Return > Take Away` = -RM 284.10
- **Issue:** Our API/database uses `Take Away` but Excel has `Birthday Take Away`.
- **Root cause:** Check if `SUBSALES_TYPE` in database includes "Birthday" prefix.

### 2. MB PD WATERFRONT - Excel Converter Issue

- **Excel structure:**
  - `Return > Delivery` = -RM 20.50
  - `Return > Drive Thru` = -RM 123.30
  - `Return Total` = -RM 143.80 (sum row)
- **Issue:** Our Excel converter is reading the "Return Total" summary row as a separate data point.
- **Fix needed:** Filter out rows where Sales Type = `Return` and Sales Return Type is empty or contains `Total`.

### 3. MB PASIR PUTEH - Missing Return in API

- **Excel shows:** `Return > Drive In` = -RM 33.30
- **API shows:** 0.00
- **Issue:** This return transaction is missing from our API output.
- **Root cause:** Need to investigate if this return exists in our database.

---

## Investigation and Fixes

### Issue 1: MB TF TAMBUN - Sub-type Categorization

**Problem:** API shows `Return > Take Away`, Xilnex shows `Return > Birthday Take Away`

**Investigation:**

- Return transaction has `SUBSALES_TYPE = 'Take Away'`
- Original sale has `SUBSALES_TYPE = 'Birthday Take Away'`
- Xilnex uses **Original Sale's SUBSALES_TYPE** for Return reporting

**Fix:** Modified SQL query in `routers/reports.py` to:

- LEFT JOIN to original sale via `REF_SALES_ID`
- Use `orig.SUBSALES_TYPE` (with fallback to `s.SUBSALES_TYPE`) for Return sub-type

```sql
LEFT JOIN dbo.com_5013_APP_4_SALES orig
    ON s.REF_SALES_ID = orig.SALES_NO AND UPPER(s.SALES_TYPE) = 'RETURN'
```

---

### Issue 2: MB PD WATERFRONT - Return Total Row

**Problem:** Excel converter reading "Return Total" summary row as data

**Investigation:**

- Excel has structure: `Return > Delivery`, `Return > Drive Thru`, `Return Total` (sum)
- "Return Total" is in `Sales Type` column, not `Sales Return Type`

**Fix:** Modified `compare_completed_all.py` to filter out rows where `Sales Type` contains 'Total':

```python
df = df[~df['Sales Type'].astype(str).str.contains('Total', na=False)]
```

---

### Issue 3: MB PASIR PUTEH - Nested Return Type

**Problem:** API shows `Return > Drive Thru`, Xilnex shows `Return > Drive In`

**Investigation:**

- Same root cause as Issue 1: Return uses its own `SUBSALES_TYPE` ('Drive Thru')
- Original sale has `SUBSALES_TYPE = 'Drive In'`

**Fix:** Same as Issue 1 - use Original Sale's SUBSALES_TYPE

---

### Excel Converter Additional Fix

**Problem:** Nested Return sub-types (e.g., `Return > Drive Thru`) had `NaN` in Sales Type column

**Fix:** Added forward-fill for `Sales Type` column:

```python
df['Sales Type'] = df['Sales Type'].ffill()
```

---

## Final Results

### May 15, 2025 Comparison (After Fixes)

| Metric         | Before          | After                |
| -------------- | --------------- | -------------------- |
| API Outlets    | 235             | 235                  |
| Xilnex Outlets | 235             | 235                  |
| API Total      | RM 1,216,858.97 | RM 1,216,858.97      |
| Xilnex Total   | RM 1,216,838.47 | RM 1,216,858.97      |
| Difference     | RM 20.50        | **RM 0.00**          |
| Match Rate     | 99.0% (803/811) | **100.0% (809/809)** |
| Discrepancies  | 8               | **0**                |

### ✅ 100% Match Achieved!

---

## Files Modified

| File                               | Change                                                               |
| ---------------------------------- | -------------------------------------------------------------------- |
| `routers/reports.py`               | Added LEFT JOIN to original sale for Return SUBSALES_TYPE            |
| `scripts/compare_completed_all.py` | Fixed Excel converter (forward-fill Sales Type, filter Return Total) |

---

## Additional Verification Tests

### Test 3: Feb 3, 2025 (Completed + Saved)

| Metric         | Value                |
| -------------- | -------------------- |
| Date           | Feb 3, 2025          |
| Filters        | Completed + Saved    |
| API Outlets    | 228                  |
| Xilnex Outlets | 228                  |
| API Total      | RM 1,587,530.34      |
| Xilnex Total   | RM 1,587,530.34      |
| Difference     | **RM 0.00**          |
| Match Rate     | **100.0%** (760/760) |
| Discrepancies  | **0**                |

### Test 4: Aug 15, 2025 (Completed + Saved)

| Metric         | Value               |
| -------------- | ------------------- |
| Date           | Aug 15, 2025        |
| Filters        | Completed + Saved   |
| API Outlets    | 235                 |
| Xilnex Outlets | 235                 |
| API Total      | RM 1,471,794.14     |
| Xilnex Total   | RM 1,471,796.49     |
| Difference     | RM 2.35             |
| Match Rate     | **99.9%** (813/814) |
| Discrepancies  | 1                   |

**Remaining Discrepancy:**

- MB CHANGLOON: `Return>Unknown` (API=-2.35, XN=0.00)
- This is an "Extra Return" case - Xilnex excludes this valid return.

---

## Root Cause Hypothesis: ETL Data Quality Issue

### Observation Pattern

| ETL Batch  | Date Range           | Test Dates            | Match Result             |
| ---------- | -------------------- | --------------------- | ------------------------ |
| **ETL #1** | Aug 2025 - Oct 2025  | Aug 1, Aug 15, Oct 10 | ⚠️ "Extra Returns" issue |
| **ETL #2** | Jan 2025 - July 2025 | Feb 3, May 15         | ✅ 100% match            |

### Analysis

- Tests within the **first ETL batch** (Aug-Oct 2025) consistently show the "Extra Returns" discrepancy where API includes valid returns that Xilnex shows as RM 0.00.
- Tests within the **second ETL batch** (Jan-July 2025) consistently achieve **100% match**.

### Hypothesis

The "Extra Returns" issue is likely a **data quality problem** from the first ETL run, not an API logic issue:

1. The first ETL may have captured incomplete return transaction data.
2. Some `REF_SALES_ID` links or return flags may not have been properly synchronized during the first ETL.
3. The second ETL (Jan-July 2025) may have had better data integrity at the time of extraction.

### Recommendation

- **For production:** Use data from the second ETL batch (Jan-July 2025) as the reliable baseline.
- **For first ETL data:** Consider re-running the ETL for Aug-Oct 2025 to refresh the data and resolve the return discrepancies.

---

## EOD Sales Summary (Detail) - Xilnex to JSON Conversion

### Objective

Convert Xilnex EOD Sales Summary (Detail) Excel export into nested JSON format for API development.

**Source File:** `EOD Sales Summary Report (Detail)_12-12-2025 (Web).xlsx`
**Output File:** `c:\laragon\www\marrybrown_api\exports\Xilnex\12-12-25_EODSalesDetail.json`

### Xilnex Excel Structure Analysis

The Xilnex Excel file has a complex hierarchical structure with merged cells:

| Level | Column           | Behavior                                    |
| ----- | ---------------- | ------------------------------------------- |
| 1     | Date             | Merged - forward-fill                       |
| 2     | Store            | Merged - forward-fill                       |
| 3     | Cashier          | Merged - forward-fill                       |
| 4     | Card Type        | Merged within Cashier block                 |
| 5     | E-Wallet Amount  | Merged within Card Type block               |
| 6     | Sales Type       | Merged within E-Wallet block                |
| 7     | Delivery Type    | Per-row (only when Sales Type = "Delivery") |
| 8     | Computer Site ID | Per-row                                     |
| 9     | Metrics          | Per-row (total_sales, net_amount, etc.)     |

### Conversion Script Development

**Script:** `c:\laragon\www\marrybrown_api\scripts\convert_eod_detail_excel.py`

**Key Implementation Challenges:**

1. **Forward-filling logic**: Different columns need different reset rules

   - Date, Store, Cashier: Global forward-fill
   - Card Type, E-Wallet Amount: Reset when Cashier changes
   - Sales Type: Reset when Card Type changes

2. **E-Wallet Amount handling**:

   - Always include this level, even when Card Type is empty
   - Default to "0" when no card type specified

3. **Delivery Type handling**:

   - Only include when Sales Type = "Delivery"
   - Skip empty values to avoid placeholder levels

4. **Data cleaning**:
   - Remove "RM " prefix from E-Wallet Amount
   - Remove trailing ".0" from Computer Site ID
   - Filter out "Total" summary rows

### Conversion Results

| Metric               | Value                                |
| -------------------- | ------------------------------------ |
| Total data rows      | 5,388                                |
| Reference comparison | 99.93% match (4 minor discrepancies) |

---

## Column Mapping Investigation for Detail API

### Objective

Identify database columns to populate the EOD Sales Summary (Detail) API response.

### Investigation Method

Ran SQL queries against `APP_4_SALES` and `APP_4_PAYMENT` tables to find column sources.

**Investigation Script:** `c:\laragon\www\marrybrown_api\scripts\find_card_cashier_columns.py`

### Findings: Cashier Name Sources

| Source                   | Table         | Top Values (Sample)                                               |
| ------------------------ | ------------- | ----------------------------------------------------------------- |
| **CASHIER**              | APP_4_SALES   | FoodPanda sales (1.4M), The Cashier (1.3M), Mustakim Hashim (52K) |
| SALES_PERSON             | APP_4_SALES   | Same as CASHIER (mirrored)                                        |
| RECEIVED_BY_CASHIER_NAME | APP_4_PAYMENT | Same values (payment-level)                                       |

**Decision:** Use `APP_4_SALES.CASHIER`

### Findings: Card Type Sources

| Source              | Table         | Key Values                                                               |
| ------------------- | ------------- | ------------------------------------------------------------------------ |
| **STRING_EXTEND_2** | APP_4_PAYMENT | VISA, MASTER, DEBIT, RM-MASTER, TNGWALLET-RM, MAYBANKQR-RM, SHOPEEPAY-RM |
| REFERENCE           | APP_4_PAYMENT | maybank (686K), VISA (106K), Xendit-DD_MAYB2U_FPX                        |
| STRING_EXTEND_1     | APP_4_PAYMENT | CCS (514K), ISA (46K) - partial codes                                    |

**Decision:** Use `APP_4_PAYMENT.STRING_EXTEND_2` - contains exact card type labels matching Xilnex format.

### Card Type Normalization Analysis

Analyzed card types in converted Xilnex JSON:

```
=== Card Types found in Xilnex JSON ===
VISA, MASTER, AMEX, DEBIT, MYDEBIT
CARD-RM, RM-VISA, RM-MASTER, RM-DEBIT
TNGWALLET-RM, MAYBANKQR-RM, SHOPEEPAY-RM, GRABPAY-RM
TouchNGo, MaybankQR, grabpay, maybank
DIRECT_DEBIT-DD_MAYB2U_FPX, DIRECT_DEBIT-DD_CIMB_FPX
... (118 unique values total)
```

**Decision:** No normalization needed - Xilnex uses raw values as-is.

### Final Column Mapping

| Xilnex Column    | Database Source                    | Notes                         |
| ---------------- | ---------------------------------- | ----------------------------- |
| Date             | `APP_4_SALES.DATETIME__SALES_DATE` | Cast to date                  |
| Store            | `LOCATION_DETAIL.LOCATIONNAME`     | JOIN on SALE_LOCATION         |
| Cashier          | `APP_4_SALES.CASHIER`              | Direct                        |
| Card Type        | `APP_4_PAYMENT.STRING_EXTEND_2`    | JOIN on INVOICE_ID = SALES_NO |
| E-Wallet Amount  | `APP_4_PAYMENT.DOUBLE_AMOUNT`      | WHERE METHOD='ewallet'        |
| Sales Type       | `APP_4_SALES.SUBSALES_TYPE`        | Existing logic                |
| Delivery Type    | `APP_4_SALES.DELIVERY_TYPE`        | Direct                        |
| Computer Site ID | `APP_4_SALES.STRING_EXTEND_3`      | Direct                        |

---

## EOD Sales Summary (Detail) API Implementation

### Implementation

Handed off to Claude with comprehensive prompt including:

- Column mappings from investigation
- Nested JSON hierarchy structure
- Key requirements (no Card Type normalization, E-Wallet defaults)
- Reference files

**Prompt File:** `c:\laragon\www\marrybrown_api\docs\CLAUDE_PROMPT_EOD_DETAIL_API.md`

### Claude Implementation Summary

1. Added `_format_amount_key()` helper for keyed e-wallet amounts
2. Added `EODSalesSummaryDetailMetrics` and `EODSalesSummaryDetailResponse` models
3. Implemented `GET /reports/eod-sales-summary-detail` endpoint with:
   - Sales-date filtering with optional location/payment status filters
   - Return-aware sales type handling
   - Payment breakdown grouped by card type and e-wallet amount
   - Nested dict structure: `date → store → cashier → card type → e-wallet → sales type → [delivery type] → computer site id`

### API Verification Testing

**Test Date:** May 15, 2025  
**API Output:** `c:\laragon\www\marrybrown_api\exports\Marrybrown\12-12-25_EODSalesDetail_API.json`

#### Initial Test Results

| Metric       | API   | Xilnex | Notes                |
| ------------ | ----- | ------ | -------------------- |
| Entries      | 6,479 | 5,354  | API has more entries |
| Stores       | 235   | 235    | ✅ Match             |
| Common paths | 3,958 | -      | About 74% overlap    |

#### Issues Found

**Issue 1: E-Wallet Level Hierarchy Mismatch**

- **Problem:** API always included E-Wallet Amount level, even for Card Type '0'
- **API showed:** `Anna/0/0/Dine In/15270` (two '0' levels)
- **Xilnex showed:** `Anna/0/Dine In/15270` (one '0' level)
- **Root cause:** E-Wallet level was always added, but Xilnex only includes it when Card Type != '0'

**Fix Applied (Line 620 in `reports.py`):**

```python
# Only include E-Wallet Amount level when Card Type is NOT '0'
has_ewallet_level = card_type != "0"
```

**Issue 2: Floating Point Precision**

- **Problem:** E-Wallet amounts had floating point artifacts
- **API showed:** `'13.800000000000001'`
- **Xilnex showed:** `'13.8'`
- **Root cause:** Python float formatting without rounding

**Fix Applied (Lines 38-41 in `reports.py`):**

```python
# Round to 2 decimal places to avoid floating point precision issues
rounded = round(float(value), 2)
str_value = format(rounded, "f")
```

#### After Fixes

| Structure Check    | Before                     | After                                |
| ------------------ | -------------------------- | ------------------------------------ |
| Card Type '0' keys | `['0', ...]` (extra level) | `['Dine In', 'Take Away', ...]` ✅   |
| TNGWALLET-RM keys  | `['13.800000000000001']`   | `['13.8']` ✅ (after server restart) |

**Note:** Server restart required for uvicorn to pick up the changes.

#### Remaining Discrepancy

Entry count difference (API: 6,479 vs Xilnex: 5,354) may be due to:

- Different date filtering logic
- Aggregation differences
- Additional data in database not in Xilnex export

**Status:** Fixes applied, pending server restart and re-verification.
