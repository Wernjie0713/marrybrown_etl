# EOD Sales Summary - Continue Comparison Work

**Date:** December 12, 2025

## Objective

Continue comparing EOD Sales Summary API output with Xilnex reports using additional test data (May 15, 2025) and different status combinations.

---

## Test 1: Additional Status Combinations (Aug 1, 2025)

Tested 3 different Sales Status / Payment Status combinations:

| #   | Sales Status | Payment Status | Match Rate          | Notes                  |
| --- | ------------ | -------------- | ------------------- | ---------------------- |
| 1   | Cancelled    | Saved          | **100%** (171/171)  | Perfect match          |
| 2   | Cancelled    | Cancelled      | **100%** (171/171)  | Perfect match          |
| 3   | Completed    | Cancelled      | **99.0%** (856/865) | 9 Return discrepancies |

**Conclusion:** API handles Cancelled sales filters perfectly. Return exclusion issue persists across different filter combinations.

---

## Test 2: Completed + All Payment Status (May 15, 2025)

**Source:** `EOD Sales Summary Report_12-12-2025 (Web) (3).xlsx`

### Comparison Results

| Metric         | Value               |
| -------------- | ------------------- |
| Date           | May 15, 2025        |
| API Outlets    | 235                 |
| Xilnex Outlets | 235                 |
| Common Outlets | 235                 |
| API Total      | RM 1,216,858.97     |
| Xilnex Total   | RM 1,216,838.47     |
| Difference     | RM 20.50            |
| **Match Rate** | **99.0%** (803/811) |
| Discrepancies  | 8                   |

### Initial Discrepancies Identified

| Store            | API Value                  | Xilnex Value                       | Type              |
| ---------------- | -------------------------- | ---------------------------------- | ----------------- |
| MB TF TAMBUN     | Return>Take Away: -284.10  | Return>Birthday Take Away: -284.10 | Sub-type mismatch |
| MB PD WATERFRONT | Return>Drive Thru: -123.30 | Return Total: -143.80              | Converter issue   |
| MB PASIR PUTEH   | Return>Drive In: 0.00      | Return>Drive In: -33.30            | Missing return    |

---

## Manual Excel Verification Findings

After manually checking the Xilnex Excel file:

### 1. MB TF TAMBUN - Sub-type Categorization Issue

- **Excel shows:** `Return > Birthday Take Away` = -RM 284.10
- **API shows:** `Return > Take Away` = -RM 284.10
- **Issue:** Our API/database uses `Take Away` but Excel has `Birthday Take Away`.
- **Root cause:** Check if `SUBSALES_TYPE` in database includes "Birthday" prefix.

### 2. MB PD WATERFRONT - Excel Converter Issue

- **Excel structure:**
  - `Return > Delivery` = -RM 20.50
  - `Return > Drive Thru` = -RM 123.30
  - `Return Total` = -RM 143.80 (sum row)
- **Issue:** Our Excel converter is reading the "Return Total" summary row as a separate data point.
- **Fix needed:** Filter out rows where Sales Type = `Return` and Sales Return Type is empty or contains `Total`.

### 3. MB PASIR PUTEH - Missing Return in API

- **Excel shows:** `Return > Drive In` = -RM 33.30
- **API shows:** 0.00
- **Issue:** This return transaction is missing from our API output.
- **Root cause:** Need to investigate if this return exists in our database.

---

## Investigation and Fixes

### Issue 1: MB TF TAMBUN - Sub-type Categorization

**Problem:** API shows `Return > Take Away`, Xilnex shows `Return > Birthday Take Away`

**Investigation:**

- Return transaction has `SUBSALES_TYPE = 'Take Away'`
- Original sale has `SUBSALES_TYPE = 'Birthday Take Away'`
- Xilnex uses **Original Sale's SUBSALES_TYPE** for Return reporting

**Fix:** Modified SQL query in `routers/reports.py` to:

- LEFT JOIN to original sale via `REF_SALES_ID`
- Use `orig.SUBSALES_TYPE` (with fallback to `s.SUBSALES_TYPE`) for Return sub-type

```sql
LEFT JOIN dbo.com_5013_APP_4_SALES orig
    ON s.REF_SALES_ID = orig.SALES_NO AND UPPER(s.SALES_TYPE) = 'RETURN'
```

---

### Issue 2: MB PD WATERFRONT - Return Total Row

**Problem:** Excel converter reading "Return Total" summary row as data

**Investigation:**

- Excel has structure: `Return > Delivery`, `Return > Drive Thru`, `Return Total` (sum)
- "Return Total" is in `Sales Type` column, not `Sales Return Type`

**Fix:** Modified `compare_completed_all.py` to filter out rows where `Sales Type` contains 'Total':

```python
df = df[~df['Sales Type'].astype(str).str.contains('Total', na=False)]
```

---

### Issue 3: MB PASIR PUTEH - Nested Return Type

**Problem:** API shows `Return > Drive Thru`, Xilnex shows `Return > Drive In`

**Investigation:**

- Same root cause as Issue 1: Return uses its own `SUBSALES_TYPE` ('Drive Thru')
- Original sale has `SUBSALES_TYPE = 'Drive In'`

**Fix:** Same as Issue 1 - use Original Sale's SUBSALES_TYPE

---

### Excel Converter Additional Fix

**Problem:** Nested Return sub-types (e.g., `Return > Drive Thru`) had `NaN` in Sales Type column

**Fix:** Added forward-fill for `Sales Type` column:

```python
df['Sales Type'] = df['Sales Type'].ffill()
```

---

## Final Results

### May 15, 2025 Comparison (After Fixes)

| Metric         | Before          | After                |
| -------------- | --------------- | -------------------- |
| API Outlets    | 235             | 235                  |
| Xilnex Outlets | 235             | 235                  |
| API Total      | RM 1,216,858.97 | RM 1,216,858.97      |
| Xilnex Total   | RM 1,216,838.47 | RM 1,216,858.97      |
| Difference     | RM 20.50        | **RM 0.00**          |
| Match Rate     | 99.0% (803/811) | **100.0% (809/809)** |
| Discrepancies  | 8               | **0**                |

### ✅ 100% Match Achieved!

---

## Files Modified

| File                               | Change                                                               |
| ---------------------------------- | -------------------------------------------------------------------- |
| `routers/reports.py`               | Added LEFT JOIN to original sale for Return SUBSALES_TYPE            |
| `scripts/compare_completed_all.py` | Fixed Excel converter (forward-fill Sales Type, filter Return Total) |

---

## Additional Verification Tests

### Test 3: Feb 3, 2025 (Completed + Saved)

| Metric         | Value                |
| -------------- | -------------------- |
| Date           | Feb 3, 2025          |
| Filters        | Completed + Saved    |
| API Outlets    | 228                  |
| Xilnex Outlets | 228                  |
| API Total      | RM 1,587,530.34      |
| Xilnex Total   | RM 1,587,530.34      |
| Difference     | **RM 0.00**          |
| Match Rate     | **100.0%** (760/760) |
| Discrepancies  | **0**                |

### Test 4: Aug 15, 2025 (Completed + Saved)

| Metric         | Value               |
| -------------- | ------------------- |
| Date           | Aug 15, 2025        |
| Filters        | Completed + Saved   |
| API Outlets    | 235                 |
| Xilnex Outlets | 235                 |
| API Total      | RM 1,471,794.14     |
| Xilnex Total   | RM 1,471,796.49     |
| Difference     | RM 2.35             |
| Match Rate     | **99.9%** (813/814) |
| Discrepancies  | 1                   |

**Remaining Discrepancy:**

- MB CHANGLOON: `Return>Unknown` (API=-2.35, XN=0.00)
- This is an "Extra Return" case - Xilnex excludes this valid return.

---

## Root Cause Hypothesis: ETL Data Quality Issue

### Observation Pattern

| ETL Batch  | Date Range           | Test Dates            | Match Result             |
| ---------- | -------------------- | --------------------- | ------------------------ |
| **ETL #1** | Aug 2025 - Oct 2025  | Aug 1, Aug 15, Oct 10 | ⚠️ "Extra Returns" issue |
| **ETL #2** | Jan 2025 - July 2025 | Feb 3, May 15         | ✅ 100% match            |

### Analysis

- Tests within the **first ETL batch** (Aug-Oct 2025) consistently show the "Extra Returns" discrepancy where API includes valid returns that Xilnex shows as RM 0.00.
- Tests within the **second ETL batch** (Jan-July 2025) consistently achieve **100% match**.

### Hypothesis

The "Extra Returns" issue is likely a **data quality problem** from the first ETL run, not an API logic issue:

1. The first ETL may have captured incomplete return transaction data.
2. Some `REF_SALES_ID` links or return flags may not have been properly synchronized during the first ETL.
3. The second ETL (Jan-July 2025) may have had better data integrity at the time of extraction.

### Recommendation

- **For production:** Use data from the second ETL batch (Jan-July 2025) as the reliable baseline.
- **For first ETL data:** Consider re-running the ETL for Aug-Oct 2025 to refresh the data and resolve the return discrepancies.
