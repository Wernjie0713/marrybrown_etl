# 22-12 Work Log - Sale Delivery API Final Verification

## ðŸŽ¯ Objective

Verify the `sale-delivery-by-sales-type` API for post-August 2025 data, specifically **31 August 2025**, to investigate potential discrepancies related to `APP_4_PAYMENT_LOG`.

---

## ðŸ› ï¸ Work Done

### 1. Verification of 31 Aug 2025 Data

- **Excel Source**: `Sale Delivery (By Sales Type) Ex Tax Calculation_22-12-2025 (Web).xlsx`
- **Process**:
  - Converted Excel to JSON (`31-08-25_SalesDeliverybySalesType_XN.json`).
  - Fetched API data for 2025-08-31.
  - Ran exact match comparison.

### 2. Performance & Timeout Fixes

- **Issue**: Initial API call for 31 Aug 2025 failed with a **500 Internal Server Error**.
- **Diagnosis**: The query took ~70 seconds, exceeding the default 30-second database timeout.
- **Fixes**:
  - **Increased Timeout**: Updated `database.py` to set `timeout=120`.
  - **Query Optimization**: Optimized `reports.py` by:
    - Replacing `COALESCE` in the `WHERE` clause with a SARGable `OR` condition.
    - Improving the `JOIN` to `EODLOG` using `TRY_CAST(s.EODLOGID AS bigint) = e.ID`.
- **Result**: Query now runs successfully within the timeout.

### 3. Comparison Results (31 Aug 2025)

| Metric                    | Match Rate (Exact) | Diffs |
| :------------------------ | :----------------- | :---- |
| **sales_transaction_qty** | **100.00%**        | 0     |
| **total_sales**           | **100.00%**        | 0     |
| **cash_amount**           | **100.00%**        | 0     |
| **other_amount**          | **100.00%**        | 0     |
| **card_amount**           | **100.00%**        | 0     |
| **summary_total**         | **100.00%**        | 0     |

---

## ðŸ“ Findings & Conclusions

### âœ… 100% Accuracy Post-August 2025

Contrary to previous suspicions, the data for **31 August 2025** matches **100% exactly** with the Xilnex export. This indicates that:

- The current API logic (using only `APP_4_PAYMENT`) is correct for this date.
- `APP_4_PAYMENT_LOG` is **not required** for the `sale-delivery-by-sales-type` report on this date.
- The API is stable and accurate for both pre-August and post-August data.

### ðŸš€ Performance Improved

The SQL optimizations have made the report significantly more robust for high-volume dates (like Sundays).

---

## ðŸ”® Next Steps

- Final review of all verification results.
- Prepare for production deployment.

---

## EOD Sales Summary â€“ Ungrouped Export Recheck (postâ€“Sale Delivery work)

- Switched back to EOD Sales Summary verification for post-Aug 2025 after finishing the Sale Delivery API.
- Found Xilnex portal supports an ungrouped export (no merged cells but with per-store total rows). Built `scripts/eod_summary/convert_eod_sales_ungrouped.py` to handle this layout, strip totals, and parse dates correctly.
- Fixed ambiguous date parsing (`01/09/2025` now handled) and regenerated XN JSON from `EOD Sales Summary Report_22-12-2025 (Web) (1).xlsx`.
- Ran API for 2025-08-31 (COMPLETED, Saved) and compared exact (no tolerance):
  - Structure: API 868 entries, XN 1,146, common 866, only API 2, only XN 280.
  - Exact per-field: 100% for total_sales, sales_net_amount, mgst_tax_amount, cash_amount, card_amount; sales_net_amount_ex_mgst 99.9%; voucher_amount 97.3%; sales_transaction_qty 96%; other_amount 51%; summary_total 13.5%.
  - Remaining gaps: XN has extra paths and zeroed `other_amount` where API has values; `summary_total` has small rounding diffs (max ~0.59).

### 15 May 2025 (Pre-Aug) Exact Comparison â€“ COMPLETED + Saved

- Converted ungrouped XN export `EOD Sales Summary Report_22-12-2025 (Web) (4).xlsx` â†’ JSON.
- Pulled API data (COMPLETED, Saved) for 2025-05-15 to `exports/Marrybrown/15-05-25_EODSalesSummary_API.json`.
- Exact match results (no tolerance):
  - Structure: API 820, XN 1,063, common 817, only API 3, only XN 246.
- Per-field exact: 100% for total_sales, sales_net_amount, sales_net_amount_ex_mgst, mgst_tax_amount; card_amount 99.9% (1 diff, max 82); cash_amount 99.9% (1 diff, max 21.9); voucher_amount 98.3% (14 diffs, max 5.1); sales_transaction_qty 96.7% (27 diffs, max 34); other_amount 46% (440 diffs, max 683.65); summary_total 12% (716 diffs, max 103.9).
- Patterns: XN often zeroes `other_amount` where API has values; many small `summary_total` diffs; some path mismatches (only-XN 246, only-API 3).

### Notes on reverting to documented EOD Summary logic

- Reapplied doc-aligned logic to `/eod-sales-summary` only (business_date from EODLOG with late-sync OR clause; negative txn count for returns). Other endpoints untouched.
- Post-revert comparison for 15 May is unchanged from pre-revert (same structure and field stats), so the remaining gaps mirror the Sale Delivery payment/rounding behaviors rather than the date/session logic.

### Applying Sale Delivery payment/rounding rules to EOD Summary (15 May re-run)

- Adjusted `/eod-sales-summary` to mirror Sale Delivery buckets and summary logic: card=`card` only; other=`other` only; voucher excludes `forfeiture_voucher`; summary_total = sum(payments) - total_rounding; added rounding_amount aggregation; returns already negative qty. Business-date logic unchanged.
- Re-ran API for 2025-05-15 (COMPLETED, Saved) and exact comparison:
  - Structure: API 808, XN 1,063, common 805, only API 3, only XN 258.
  - Per-field exact: total_sales 98.5%, sales_net_amount 98.5%, sales_net_amount_ex_mgst 98.5%, mgst_tax_amount 98.9%, card_amount 99.8% (max diff 194.25), cash_amount 99.3% (max diff 449.75), voucher_amount 98.3% (max diff 5.1), sales_txn_qty 98.5% (max diff 26), other_amount 45.1% (max diff 939.04), summary_total 11.9% (max diff 939.18).
  - Outcome: Match rates worsened versus the prior run; major regressions in other_amount/summary_total and some totals. Indicates the Sale Delivery payment visibility rules do not map cleanly to EOD Summary; likely need EOD-specific payment/summary handling.

### Rollback to only useful EOD Summary logic

- Removed Sale Delivery-only changes (narrow payment buckets and rounding subtraction) to keep EOD logic minimal.
- Current EOD Summary logic kept:
  - EOD business_date filter with late-sync OR clause.
  - Negative transaction qty for returns.
  - Return subtype from original sale.
  - Inclusive payment buckets (card includes bank/debitcard, voucher includes forfeiture_voucher, other includes remaining methods) and summary_total = sum of payments.

### Converter fix: preserve empty sales return type level

- Updated `scripts/eod_summary/convert_eod_sales_ungrouped.py` to always include a `sales_return_type` node (even when empty) so paths match XN (no collapsing). Regenerated `EOD Sales Summary Report_22-12-2025 (Web) (4).json` with the fix.

### Cleanup: remove empty sales_type/sales_return_type buckets

- Removed API-side injection of empty `"" -> ""` zero-metrics rows so the response only includes real data.
- Updated converter to skip rows where both Sales Type and Sales Return Type are empty and all metrics are zero (prevents `{ \"\": {} }` stubs).
